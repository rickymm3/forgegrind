<% pet = user_pet.pet %>
<% pet_name = user_pet.name.presence || pet.name %>
<% leveling_items ||= [] %>
<% xp_ratio   = (user_pet.exp.to_f / UserPet::EXP_PER_LEVEL).clamp(0.0, 1.0) %>
<% xp_percent = (xp_ratio * 100).round(1) %>
<% exploring    = user_pet.exploring? %>
<% asleep_until = user_pet.asleep_until %>
<% sleeping     = asleep_until.present? && Time.current < asleep_until %>
<% can_level    = user_pet.exp.to_i >= UserPet::EXP_PER_LEVEL %>
<% maxed_level  = user_pet.level >= UserPet::LEVEL_CAP %>
<% level_up_disabled = maxed_level || exploring || sleeping || !can_level %>
<% actions_catalog = [
  { key: "play",   label: "Play",   emoji: "üéæ" },
  { key: "wash",   label: "Groom",  emoji: "üßº" },
  { key: "feed",   label: "Feed",   emoji: "üçñ" },
  { key: "treat",  label: "Treat",  emoji: "üíä" },
  { key: "cuddle", label: "Cuddle", emoji: "ü§ó" },
  { key: "walk",   label: "Walk",   emoji: "üß≠" },
  { key: "rainbow_fruit", label: "Rainbow Fruit", emoji: "üåà" }
].select { |action| PetCareService::ACTIONS.key?(action[:key]) } %>
<% disabled_actions = exploring || sleeping %>
<% care_item_counts = current_user.user_items.includes(:item).each_with_object({}) do |user_item, memo|
     memo[user_item.item.item_type.to_s] = user_item.quantity.to_i
   end %>

<section class="pet-panel pet-panel--details"
         data-controller="pet-display"
         data-action="action-panel:preview->pet-display#handlePreview">
  <div class="pet-panel__grid">
    <div class="pet-panel__column">
      <div class="pet-panel__header-row">
      <%= link_to overview_panel_user_pet_path(user_pet),
                  class: "pet-panel__back-button",
                  data: { turbo_frame: user_pet_panel_dom_id(user_pet) } do %>
        <span class="pet-panel__back-icon" aria-hidden="true">‚Üê</span>
        <span class="sr-only">Back to overview</span>
      <% end %>
      <div class="pet-panel__header-text">
        <p class="pet-panel__eyebrow">Care Status</p>
        <h2 class="pet-panel__title"><%= pet_name %></h2>
      </div>
        <div class="pet-panel__stat">
          <span class="pet-panel__label">Level</span>
          <span class="pet-panel__value"><%= user_pet.level %></span>
        </div>
      </div>

      <div class="pet-panel__bars">
        <div class="pet-bar pet-bar--xp">
          <div class="pet-bar__header">
            <span class="pet-panel__label">Experience</span>
            <span class="pet-bar__value"
                  data-pet-display-target="xpText"
                  data-base-before="<%= user_pet.exp %>"
                  data-base-after="<%= user_pet.exp %>"
                  data-base-text="<%= "#{user_pet.exp} / #{UserPet::EXP_PER_LEVEL} XP" %>"
                  data-max-value="<%= UserPet::EXP_PER_LEVEL %>">
              <%= user_pet.exp %> / <%= UserPet::EXP_PER_LEVEL %> XP
            </span>
          </div>
          <div class="pet-bar__track">
            <div class="pet-bar__fill pet-bar__fill--xp"
                 data-pet-display-target="xpBar"
                 data-base-percent="<%= xp_percent %>"
                 data-max-value="<%= UserPet::EXP_PER_LEVEL %>"
                 style="width: <%= xp_percent %>%"></div>
          </div>
          <span class="pet-bar__percent"
                data-pet-display-target="xpValue"
                data-base-text="<%= number_to_percentage(xp_percent, precision: 1) %>"
                data-base-percent="<%= xp_percent %>">
            <%= number_to_percentage(xp_percent, precision: 1) %>
          </span>
        </div>

        <div id="pet_energy_<%= user_pet.id %>" class="pet-bar pet-bar--energy">
          <%= render "user_pets/energy_display", user_pet: user_pet %>
        </div>
      </div>

      <div class="pet-panel__level">
        <div class="pet-panel__level-info">
          <span class="pet-panel__label">Next Level</span>
          <% if level_up_disabled %>
            <p class="pet-panel__helper">
              <% if maxed_level %>
                Max level reached
              <% elsif exploring %>
                Unavailable while exploring
              <% elsif sleeping %>
                Resting ‚Äî check back soon
              <% else %>
                Earn <%= UserPet::EXP_PER_LEVEL - user_pet.exp.to_i %> more XP
              <% end %>
            </p>
          <% else %>
            <p class="pet-panel__helper">Ready to level up now.</p>
          <% end %>
        </div>
        <% unless level_up_disabled %>
          <%= form_with url: level_up_user_pet_path(user_pet),
                        method: :post,
                        class: "pet-panel__level-form" do |f| %>
            <div class="pet-panel__level-field">
              <label for="held_user_item_id" class="pet-panel__label">Hold an item (optional)</label>
              <% if leveling_items.present? %>
                <%= f.collection_select :held_user_item_id,
                                        leveling_items,
                                        :id,
                                        ->(user_item) { "#{user_item.item.name} (#{user_item.quantity})" },
                                        { include_blank: "None" },
                                        class: "pet-panel__select" %>
              <% else %>
                <p class="pet-panel__helper">No compatible items available.</p>
                <%= f.hidden_field :held_user_item_id, value: nil %>
              <% end %>
            </div>
            <%= f.submit "Level Up", class: "pet-panel__primary-button" %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="pet-panel__column">
      <turbo-frame id="<%= pet_stats_dom_id(user_pet) %>">
        <%= render "user_pets/stats_grid", user_pet: user_pet %>
      </turbo-frame>
    </div>

    <div class="pet-panel__full-row">
      <div class="pet-care-panel">
        <%= render "user_pets/action_panel_frame",
                   user_pet: user_pet,
                   context: :page,
                   state: :idle,
                   needs_preview: [],
                   personality_changes: [] %>

        <div class="pet-care-actions">
          <% care_item_resolver = CareItemResolver.new(current_user) %>
          <% actions_catalog.each do |action| %>
            <% definition = PetCareService::ACTIONS[action[:key]] %>
            <% optional_items = care_item_resolver.available_for(action[:key]) %>
            <%= button_to interact_preview_user_pet_path(user_pet),
                          method: :post,
                          params: { interaction_type: action[:key], context: :page },
                          form: {
                            class: "pet-care-actions__form",
                            data: {
                              turbo_frame: action_panel_dom_id(user_pet),
                              "pet-display-target": "careForm"
                            }
                          },
                          disabled: disabled_actions,
                          class: "pet-care-actions__button",
                          title: action[:label],
                          aria: { label: "#{action[:label]} action" } do %>
              <% required_types = Array(definition[:required_item_types]) %>
              <% if required_types.any? %>
                <div class="pet-care-actions__stock">
                  <% required_types.each do |type| %>
                    <% quantity = care_item_counts[type.to_s].to_i %>
                    <span><%= quantity %>√ó <%= type.to_s.humanize %></span>
                  <% end %>
                </div>
              <% elsif optional_items.any? %>
                <div class="pet-care-actions__stock">
                  <span class="optional-boost-pill">Optional boost items available</span>
                </div>
              <% end %>
              <span class="pet-care-actions__emoji"><%= action[:emoji] %></span>
              <span class="pet-care-actions__label"><%= action[:label] %></span>
              <% if definition[:energy_cost].to_i.positive? %>
                <span class="pet-care-actions__energy"><%= definition[:energy_cost] %> EN</span>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

</section>
