<% context             = (defined?(local_assigns) && local_assigns.fetch(:context, nil)) || :page %>
<% state               = (defined?(local_assigns) && local_assigns.fetch(:state, nil)) || :idle %>
<% state               = state.to_sym if state.respond_to?(:to_sym) %>
<% message             = (defined?(local_assigns) && local_assigns.fetch(:message, nil)) %>
<% interaction         = (defined?(local_assigns) && local_assigns.fetch(:interaction, nil)) %>
<% energy_cost         = (defined?(local_assigns) && local_assigns.fetch(:energy_cost, nil)) %>
<% requirements        = (defined?(local_assigns) && local_assigns.fetch(:requirements, nil)) || [] %>
<% needs_preview       = (defined?(local_assigns) && local_assigns.fetch(:needs_preview, nil)) || [] %>
<% personality_changes = (defined?(local_assigns) && local_assigns.fetch(:personality_changes, nil)) || [] %>
<% needs_snapshot      = (defined?(local_assigns) && local_assigns.fetch(:needs_snapshot, nil)) || [] %>
<% preview_json        = ERB::Util.json_escape(needs_preview.to_json) %>
<% needs_snapshot_json = ERB::Util.json_escape(needs_snapshot.to_json) %>
<% state_value         = state.to_s %>
<% energy_before_value = preview_energy_before.to_f %>
<% energy_after_value  = preview_energy_after.to_f %>
<% xp_before_value     = preview_xp_before.to_i %>
<% xp_after_value      = preview_xp_after.to_i %>
<% xp_gain_value       = preview_xp_gain.to_i %>
<% action_frame_dom_id = action_panel_dom_id(user_pet) %>
<% primary_item        = requirements.first %>
<% primary_name        = primary_item&.dig(:item)&.name || primary_item&.dig(:type)&.to_s&.humanize %>
<% primary_desc        = primary_item&.dig(:description) %>
<% aria_live           = state == :confirm ? "polite" : "off" %>
<% use_item_flag      = defined?(use_item) ? use_item : nil %>
<% care_item_options = defined?(care_item_options) ? Array(care_item_options) : [] %>
<% autoclose          = defined?(autoclose) ? autoclose : false %>

<div class="pet-care-preview pet-care-preview--<%= state_value %>"
     data-controller="action-panel"
     data-action-panel-preview-value="<%= preview_json %>"
     data-action-panel-state-value="<%= state_value %>"
     data-action-panel-energy-before-value="<%= energy_before_value %>"
     data-action-panel-energy-after-value="<%= energy_after_value %>"
     data-action-panel-xp-before-value="<%= xp_before_value %>"
     data-action-panel-xp-after-value="<%= xp_after_value %>"
     data-action-panel-xp-gain-value="<%= xp_gain_value %>"
     data-action-panel-needs-after-value="<%= needs_snapshot_json %>"
     data-action-panel-autoclose-value="<%= autoclose %>"
     aria-live="<%= aria_live %>">
  <% case state %>
  <% when :idle %>
    <p class="pet-care-preview__placeholder">
      Choose a care action to preview its effects on <%= user_pet.name.presence || user_pet.pet.name %>.
    </p>

  <% when :error %>
    <% missing = requirements.select { |req| req[:quantity].to_i < req[:required_quantity].to_i } %>
    <div class="pet-care-preview__status pet-care-preview__status--error">
      <div>
        <p class="pet-care-preview__status-title"><%= message.presence || "Action unavailable." %></p>
        <% if missing.any? %>
          <p class="pet-care-preview__status-helper">You're missing:</p>
          <ul class="pet-care-preview__status-list">
            <% missing.each do |req| %>
              <li><%= req[:item]&.name || req[:type].to_s.humanize %> (<%= req[:quantity] %> / <%= req[:required_quantity] %>)</li>
            <% end %>
          </ul>
        <% end %>
      </div>
      <%= button_to interact_preview_user_pet_path(user_pet),
                    method: :post,
                    params: { cancel: 1, context: context },
                    form: { data: { turbo_frame: action_frame_dom_id, 'action-panel-target': 'cancelForm' } },
                    class: "pet-care-preview__clear" do %>
        Clear
      <% end %>
    </div>

  <% when :success %>
    <div class="pet-care-preview__status pet-care-preview__status--success">
      <div>
        <p class="pet-care-preview__status-title"><%= message.presence || "Action completed." %></p>
        <% if primary_name.present? %>
          <p class="pet-care-preview__status-helper"><%= primary_name %> consumed.</p>
        <% end %>
      </div>
      <%= button_to interact_preview_user_pet_path(user_pet),
                    method: :post,
                    params: { cancel: 1, context: context },
                    form: { data: { turbo_frame: action_frame_dom_id, 'action-panel-target': 'cancelForm' } },
                    class: "pet-care-preview__clear" do %>
        Close
      <% end %>
    </div>

  <% when :confirm %>
    <% interaction_label = interaction.present? ? interaction.to_s.humanize : "Care Action" %>
    <% summary_text = primary_desc.presence || message.presence || "Ready to #{interaction_label.downcase}." %>
    <div class="pet-care-preview__header">
        <div class="pet-care-preview__summary">
          <p class="pet-care-preview__eyebrow"><%= interaction_label %></p>
          <p class="pet-care-preview__description"><%= summary_text %></p>
          <div class="pet-care-preview__meta">
            <% if energy_cost.present? %>
              <span><strong><%= energy_cost %></strong> energy</span>
            <% end %>
            <% if requirements.present? %>
              <span>
                <% requirements.each do |req| %>
                  <em><%= req[:item]&.name || req[:type].to_s.humanize %></em>
                  (<%= req[:quantity] %>/<%= req[:required_quantity] %>)
                  <% unless req.equal?(requirements.last) %> â€¢ <% end %>
                <% end %>
              </span>
            <% end %>
          </div>
        </div>
      <div class="pet-care-preview__cta">
        <%= button_to interact_preview_user_pet_path(user_pet),
                      method: :post,
                      params: { cancel: 1, context: context },
                      form: { data: { turbo_frame: action_frame_dom_id, 'action-panel-target': 'cancelForm' } },
                      class: "pet-care-preview__clear" do %>
          Clear
        <% end %>
        <%= form_with url: interact_user_pet_path(user_pet),
                      method: :post,
                      data: { turbo_frame: action_frame_dom_id },
                      class: "pet-care-preview__use-form" do %>
          <%= hidden_field_tag :interaction_type, interaction %>
          <%= hidden_field_tag :context, context %>
          <% if requirements.present? %>
            <label class="pet-care-preview__item-toggle">
              <%= check_box_tag :use_item, true, use_item_flag.nil? ? true : use_item_flag %>
              <span>Use required item(s)</span>
            </label>
          <% else %>
            <%= hidden_field_tag :use_item, false %>
          <% end %>
          <% if care_item_options.any? %>
            <div class="pet-care-preview__care-items space-y-3">
              <div class="flex items-center justify-between">
                <p class="pet-care-preview__item-toggle text-sm font-semibold text-slate-200">Choose a care item (optional)</p>
                <span class="inline-flex items-center rounded-full bg-indigo-500/10 px-3 py-1 text-xs font-semibold text-indigo-200">Boost available</span>
              </div>
              <div class="grid gap-3 sm:grid-cols-2">
                <% none_id = "care-item-none-#{interaction}" %>
                <label for="<%= none_id %>" class="group relative rounded-xl border border-slate-800/70 bg-slate-900/60 px-4 py-3 shadow-inner shadow-slate-950/40 transition hover:border-indigo-500/50 hover:-translate-y-0.5">
                  <%= radio_button_tag :care_item, "", true, id: none_id, class: "peer sr-only" %>
                  <div class="flex flex-col gap-1">
                    <p class="text-sm font-semibold text-slate-100">No extra item</p>
                    <p class="text-xs text-slate-400">Use action baseline only</p>
                  </div>
                  <span class="pointer-events-none absolute inset-0 rounded-xl ring-2 ring-indigo-400/0 transition peer-checked:ring-2 peer-checked:ring-indigo-400/80"></span>
                </label>

                <% care_item_options.each do |entry| %>
                  <% entry_id = "care-item-#{entry.item_type}" %>
                  <% stats = entry.stats || {} %>
                  <% icon_path = care_item_image_path(entry.item_type) rescue nil %>
                  <label for="<%= entry_id %>" class="group relative rounded-xl border border-slate-800/70 bg-slate-900/60 px-4 py-3 shadow-inner shadow-slate-950/40 transition hover:border-indigo-500/50 hover:-translate-y-0.5">
                    <%= radio_button_tag :care_item, entry.item_type, false, id: entry_id, class: "peer sr-only" %>
                    <div class="flex items-start gap-3">
                      <% if icon_path.present? %>
                        <img src="<%= icon_path %>" alt="<%= entry.name %>" class="h-10 w-10 rounded-lg bg-slate-800/70 p-1 object-contain" />
                      <% else %>
                        <div class="h-10 w-10 rounded-lg bg-slate-800/70" aria-hidden="true"></div>
                      <% end %>
                      <div class="flex-1 space-y-1">
                        <p class="text-sm font-semibold text-slate-100"><%= entry.name %></p>
                        <p class="text-xs text-slate-400">Owned: <%= entry.quantity %></p>
                        <% if stats.any? %>
                          <div class="flex flex-wrap gap-2 text-[11px] text-slate-200">
                            <% stats.each do |k, v| %>
                              <% sign = v.to_f >= 0 ? "+" : "" %>
                              <span class="rounded-full bg-slate-800/60 px-2 py-1"><%= "#{k.to_s.humanize}: #{sign}#{v}" %></span>
                            <% end %>
                          </div>
                        <% end %>
                        <% if entry.coin_buff %>
                          <% boost_pct = (entry.coin_buff[:multiplier].to_f * 100).round %>
                          <p class="text-[11px] font-semibold text-emerald-300">Coin boost +<%= boost_pct %>% for <%= entry.coin_buff[:duration_minutes] %>m</p>
                        <% end %>
                      </div>
                    </div>
                    <span class="pointer-events-none absolute inset-0 rounded-xl ring-2 ring-indigo-400/0 transition peer-checked:ring-2 peer-checked:ring-indigo-400/80"></span>
                  </label>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="rounded-lg border border-slate-800/60 bg-slate-900/50 px-4 py-3 text-xs text-slate-400">
              No optional care items available for this action.
            </div>
          <% end %>
          <button type="submit" class="pet-care-preview__use">Use</button>
        <% end %>
      </div>
    </div>

  <% end %>
</div>
