<% xp_needed = UserPet::EXP_PER_LEVEL %>
<% xp_remaining = [xp_needed - user_pet.exp.to_i, 0].max %>

<section class="level-up-panel">
  <div class="level-up-panel__header">
    <div>
      <p class="level-up-panel__eyebrow">Level Up</p>
      <h3 class="level-up-panel__title"><%= user_pet.name.presence || user_pet.pet.name %></h3>
      <p class="level-up-panel__subtitle">Level <%= user_pet.level %> â†’ <%= user_pet.level + 1 %></p>
    </div>
    <div class="level-up-panel__xp">
      <span><%= user_pet.exp %> / <%= xp_needed %> XP</span>
      <% if xp_remaining.positive? %>
        <p>Earn <%= xp_remaining %> more XP</p>
      <% else %>
        <p>Ready to level up</p>
      <% end %>
    </div>
  </div>

  <div class="level-up-panel__body">
    <%= form_with url: level_up_user_pet_path(user_pet), method: :post, data: { turbo_frame: "_top" }, class: "level-up-panel__form" do |f| %>
      <div class="level-up-panel__field">
        <label for="held_user_item_id" class="level-up-panel__label">Hold an item (optional)</label>
        <% if leveling_items.present? %>
          <%= f.collection_select :held_user_item_id,
                                  leveling_items,
                                  :id,
                                  ->(user_item) { "#{user_item.item.name} (#{user_item.quantity})" },
                                  { include_blank: "None" },
                                  class: "level-up-panel__select" %>
        <% else %>
          <p class="level-up-panel__helper">No compatible items available.</p>
          <%= f.hidden_field :held_user_item_id, value: nil %>
        <% end %>
      </div>

      <div class="level-up-panel__actions">
        <%= f.submit "Confirm Level Up", class: "level-up-panel__primary" %>
        <%= button_to "Cancel",
                      reset_panel_user_pet_path(user_pet, format: :turbo_stream),
                      method: :post,
                      form: { data: { turbo_stream: true, turbo_frame: dom_id(user_pet, :panel) }, class: "level-up-panel__cancel-form" },
                      class: "level-up-panel__secondary" %>
      </div>
    <% end %>
  </div>
</section>
