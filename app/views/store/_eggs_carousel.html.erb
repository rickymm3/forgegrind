<% highlighted_egg_id = local_assigns[:highlighted_egg_id] %>

<% if eggs.any? %>
  <div class="space-y-4">
    <div class="overflow-x-auto" style="overflow-x: scroll;">
      <div class="flex w-full items-center justify-between gap-3 px-2 sm:px-0">
        <div>
          <h2 class="text-xl font-semibold text-slate-100">Available eggs</h2>
          <p class="text-sm text-slate-400">Each shell contains a surprise companion with its own rarity and traits.</p>
        </div>
        <%= link_to "View nursery",
                    user_pets_path(collection: "eggs"),
                    class: "inline-flex items-center gap-2 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-indigo-100 transition hover:bg-indigo-500/20 shrink-0" %>
      </div>
    </div>

    <div class="overflow-x-auto" style="overflow-x: scroll;">
      <div class="flex w-max snap-x snap-mandatory gap-4 px-2 sm:px-0 flex-nowrap">
        <% eggs.each do |egg| %>
          <% image_path   = egg_image_path(egg) %>
          <% highlight    = highlighted_egg_id.present? && highlighted_egg_id == egg.id %>
          <% can_afford   = current_user.can_afford_egg?(egg) rescue true %>
          <% border_class = highlight ? "border-emerald-400/80 ring-4 ring-emerald-400/30 shadow-emerald-400/30" : "border-slate-800 hover:border-indigo-500/40" %>

          <article class="group relative flex snap-center flex-col overflow-hidden rounded-3xl border bg-slate-950/70 shadow-inner shadow-slate-950/40 transition shrink-0 <%= border_class %>"
                   style="min-width: 360px; width: 360px; height: 470px;">
            <div class="relative aspect-[4/3] w-full overflow-hidden bg-slate-900">
              <% if image_path.present? %>
                <%= image_tag image_path,
                              alt: "#{egg.name} egg",
                              class: "h-full w-full object-cover transition duration-300 group-hover:scale-105" %>
              <% else %>
                <div class="flex h-full w-full items-center justify-center text-sm text-slate-500">Artwork pending</div>
              <% end %>
            </div>

            <div class="flex flex-1 flex-col gap-4 p-4">
              <header class="space-y-1">
                <h3 class="text-lg font-semibold text-slate-100"><%= egg.name %></h3>
                <% if egg.hatch_duration.present? %>
                  <p class="text-xs uppercase tracking-wide text-slate-500">Hatch time: <%= distance_of_time_in_words(Time.current, egg.hatch_duration.seconds.from_now) %></p>
                <% end %>
              </header>

              <div class="space-y-2 text-sm text-slate-300">
                <% if egg.currency && egg.cost_amount.to_i.positive? %>
                  <div class="flex items-center justify-between rounded-2xl border border-slate-800/70 bg-slate-950/60 px-3 py-2">
                    <span class="font-semibold text-slate-100">Cost</span>
                    <span class="text-indigo-200"><%= egg.cost_amount %> <%= egg.currency.name %></span>
                  </div>
                <% end %>

                <% if egg.egg_item_costs.any? %>
                  <details class="rounded-2xl border border-slate-800/70 bg-slate-950/60 px-3 py-2 text-xs text-slate-300">
                    <summary class="cursor-pointer text-xs font-semibold text-slate-200">Required items</summary>
                    <ul class="mt-2 space-y-1">
                      <% egg.egg_item_costs.includes(:item).each do |cost| %>
                        <li class="flex items-center justify-between text-[11px] text-slate-400">
                          <span><%= cost.item.name %></span>
                          <span class="font-semibold text-slate-200">x<%= cost.quantity %></span>
                        </li>
                      <% end %>
                    </ul>
                  </details>
                <% end %>
              </div>

              <% if highlight %>
                <div class="rounded-2xl border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 shadow-inner">
                  +1 <%= egg.name %> added to your nursery!
                </div>
              <% end %>

              <div class="mt-auto">
                <%= form_with url: user_eggs_path,
                              method: :post,
                              data: { controller: "loading-button", action: "turbo:submit-start->loading-button#start turbo:submit-end->loading-button#stop" },
                              class: "space-y-2" do |f| %>
                  <%= hidden_field_tag :egg_id, egg.id %>
                  <%= hidden_field_tag :origin, "store" %>
                  <% unless can_afford %>
                    <p class="text-[11px] text-amber-300">You need more resources to adopt this egg.</p>
                  <% end %>
                  <% button_classes = if can_afford
                                        "w-full inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                                      else
                                        "w-full inline-flex items-center justify-center gap-2 rounded-xl border border-slate-700/60 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-500 cursor-not-allowed"
                                      end %>
                  <%= f.button "Adopt",
                               type: :submit,
                               class: button_classes,
                               disabled: !can_afford,
                               data: { "loading-button-target": "button" } %>
                <% end %>
              </div>
            </div>
          </article>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="rounded-3xl border border-slate-800 bg-slate-950/70 p-8 text-center text-slate-300">
    <h2 class="text-xl font-semibold text-slate-100">No eggs available right now</h2>
    <p class="mt-2 text-sm">Check back soonâ€”new clutches arrive throughout the week.</p>
  </div>
<% end %>
