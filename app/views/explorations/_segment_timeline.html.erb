<%#
  locals:
    - nodes: array of { label:, status: }
    - edge_count: optional integer count of edges (defaults to nodes.size - 1)
    - completed_edges: optional integer count of fully completed edges
    - active_edge_fraction: optional float (0..1) representing partial progress on the current edge
%>
<% nodes = Array(nodes) %>
<% total_edges = (local_assigns[:edge_count] || local_assigns[:total_edges] || nodes.size - 1).to_i %>
<% total_edges = 1 if total_edges <= 0 %>
<% completed_edges = (local_assigns[:completed_edges] || 0).to_i.clamp(0, total_edges) %>
<% active_edge_fraction = (local_assigns[:active_edge_fraction] || 0.0).to_f.clamp(0.0, 1.0) %>
<div class="segment-timeline">
  <div class="segment-timeline__row">
    <% nodes.each_with_index do |node, idx| %>
      <% status = node[:status].to_s %>
      <% indicator_classes =
           case status
           when 'completed' then "segment-timeline__dot--completed"
           when 'checkpoint' then "segment-timeline__dot--checkpoint"
           when 'active' then "segment-timeline__dot--active"
           else "segment-timeline__dot--upcoming"
           end %>
      <div class="segment-timeline__node">
        <span class="segment-timeline__dot <%= indicator_classes %>"></span>
        <span class="segment-timeline__label <%= status == 'completed' ? 'segment-timeline__label--muted' : '' %>">
          <%= node[:label] %>
        </span>
      </div>
      <% next if idx == nodes.size - 1 %>
      <% edge_index = idx %>
      <% bar_percent =
           if edge_index < completed_edges
             100.0
           elsif edge_index == completed_edges
             (active_edge_fraction * 100.0).clamp(0.0, 100.0)
           else
             0.0
           end %>
      <% bar_state =
           if bar_percent >= 99.5
             "segment-timeline__bar-fill--complete"
           elsif bar_percent.positive?
             "segment-timeline__bar-fill--active"
           else
             "segment-timeline__bar-fill--idle"
           end %>
      <div class="segment-timeline__bar" aria-hidden="true">
        <span class="segment-timeline__bar-fill <%= bar_state %>"
              style="width: <%= format('%.2f', bar_percent) %>%"
              data-edge-index="<%= edge_index %>"
              data-countdown-target="barFill"></span>
      </div>
    <% end %>
  </div>
</div>
