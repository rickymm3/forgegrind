<% content_for :title, "Pets" %>

<div class="relative flex min-h-screen flex-col" data-controller="pet-hub" data-pet-hub-active-value="<%= @active_collection %>">
  <header class="sticky top-0 z-40 border-b border-slate-800 bg-slate-950/85 backdrop-blur supports-[backdrop-filter]:bg-slate-950/60"
          style="min-height: 10vh; max-height: 100px;">
    <div class="mx-auto flex h-full w-full max-w-4xl items-center justify-between gap-4 px-4 py-3">
      <button type="button"
              class="inline-flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-700/60 bg-slate-900/60 text-slate-300 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-action="click->pet-hub#select"
              data-pet-hub-target="toggle"
              data-collection="eggs"
              aria-pressed="false"
              aria-label="Show eggs">
        <svg aria-hidden="true" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4">
          <path d="M12 21c4.4 0 8-3.6 8-8 0-3.4-2.2-8-8-13-5.8 5-8 9.6-8 13 0 4.4 3.6 8 8 8z" />
        </svg>
      </button>

      <div class="flex flex-col items-center text-center">
        <span class="text-lg font-semibold uppercase tracking-wide text-slate-100">Pets</span>
        <span class="text-xs text-slate-400">
          <%= pluralize(@user_pets.size, "pet") %> · <%= pluralize(@user_eggs.size, "egg") %>
        </span>
      </div>

      <button type="button"
              class="inline-flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-700/60 bg-slate-900/60 text-slate-300 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
              data-action="click->pet-hub#select"
              data-pet-hub-target="toggle"
              data-collection="pets"
              aria-pressed="false"
              aria-label="Show pets">
        <svg aria-hidden="true" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4">
          <path d="M4.8 10.2c0-2.7 2.3-4.9 5.2-4.9 1.3 0 2.5.5 3.5 1.3.9-.8 2.1-1.3 3.4-1.3 2.9 0 5.2 2.2 5.2 4.9 0 4.9-8.6 9.5-8.6 9.5S4.8 15.1 4.8 10.2z" />
        </svg>
      </button>
    </div>
  </header>

  <div class="mx-auto w-full max-w-4xl flex-1 px-4 pb-28 pt-6">
    <section class="space-y-6" data-pet-hub-target="panel" data-collection="pets">
      <% if @user_pets.any? %>
        <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
          <% @user_pets.each do |user_pet| %>
            <% display_name = user_pet.name.presence || user_pet.pet.name %>
            <% sprite_path = pet_sprite_path(user_pet.pet) %>
            <% badge_text = "Lvl #{user_pet.level}" %>
            <%= link_to user_pet_path(user_pet),
                        class: "group relative block aspect-[3/4] overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/60 shadow-inner shadow-slate-950/40 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                        data: { turbo_prefetch: false },
                        aria: { label: "#{display_name} – #{badge_text}" } do %>
              <span class="sr-only"><%= display_name %></span>
              <% if sprite_path.present? %>
                <%= image_tag sprite_path,
                              alt: "",
                              loading: "lazy",
                              class: "absolute inset-0 h-full w-full object-cover transition duration-200 group-hover:scale-105" %>
              <% else %>
                <div class="absolute inset-0 flex items-center justify-center bg-slate-800 text-sm text-slate-300">
                  <%= display_name %>
                </div>
              <% end %>
              <span class="absolute top-2 right-2 inline-flex items-center rounded-full bg-slate-950/85 px-2 py-1 text-[11px] font-semibold text-indigo-200 drop-shadow-md" aria-label="Level <%= user_pet.level %>">
                <%= badge_text %>
              </span>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-10 text-center text-slate-300">
          <p class="text-base font-semibold text-slate-100">No pets yet</p>
          <p class="mt-2 text-sm">Open eggs to hatch your first companion.</p>
          <%= link_to "Visit the Store",
                      adopt_path,
                      class: "mt-4 inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950" %>
        </div>
      <% end %>
    </section>

    <section class="space-y-6 hidden" data-pet-hub-target="panel" data-collection="eggs">
      <% if @user_eggs.any? %>
        <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
          <% @user_eggs.each do |user_egg| %>
            <% egg = user_egg.egg %>
            <% badge_text = if user_egg.hatched?
                               "Hatched"
                             elsif user_egg.hatching?
                               remaining = user_egg.hatch_time_remaining
                               remaining <= 0 ? "Ready" : "#{(remaining / 60.0).ceil}m"
                             else
                               "Idle"
                             end %>
            <% image_path = egg_image_path(egg) %>
            <%= link_to user_egg_path(user_egg),
                        class: "group relative block aspect-[3/4] overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/60 shadow-inner shadow-slate-950/40 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                        data: { turbo_prefetch: false },
                        aria: { label: "#{egg.name} egg – #{badge_text}" } do %>
              <span class="sr-only"><%= egg.name %></span>
              <% if image_path.present? %>
                <%= image_tag image_path,
                              alt: "",
                              loading: "lazy",
                              class: "absolute inset-0 h-full w-full object-cover transition duration-200 group-hover:scale-105" %>
              <% else %>
                <div class="absolute inset-0 flex items-center justify-center bg-slate-800 text-sm text-slate-300">
                  <%= egg.name %>
                </div>
              <% end %>
              <span class="absolute top-2 right-2 inline-flex items-center rounded-full bg-slate-950/85 px-2 py-1 text-[11px] font-semibold text-amber-200 drop-shadow-md" aria-label="Egg status <%= badge_text %>">
                <%= badge_text %>
              </span>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-10 text-center text-slate-300">
          <p class="text-base font-semibold text-slate-100">No eggs in incubation</p>
          <p class="mt-2 text-sm">Pick up a new egg from the store to start hatching.</p>
          <%= link_to "Browse Store",
                      adopt_path,
                      class: "mt-4 inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950" %>
        </div>
      <% end %>
    </section>
  </div>
</div>
