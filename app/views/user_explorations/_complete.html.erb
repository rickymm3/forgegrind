<% generated = @generated_snapshot %>
<% expedition_name = generated&.name || @world.name %>
<% cooldown_seconds = generated&.respond_to?(:cooldown_remaining_seconds) ? generated.cooldown_remaining_seconds : 0 %>
<% cooldown_seconds = cooldown_seconds.to_i %>

<div class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div class="space-y-1">
      <p class="text-sm font-semibold text-green-600 inline-flex items-center gap-2">
        <span class="inline-flex h-2 w-2 rounded-full bg-green-500"></span>
        Expedition Complete
      </p>
      <h2 class="text-2xl font-bold text-slate-900"><%= expedition_name %></h2>
      <p class="text-sm text-slate-500">
        Your party returns with newfound experience and loot.
      </p>
      <% if @granted_chest_type.present? %>
        <div class="inline-flex items-center gap-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10 px-3 py-2 text-sm text-indigo-200">
          <div class="flex items-center gap-2">
            <%= image_tag asset_path(@granted_chest_type.icon),
                          alt: @granted_chest_type.name,
                          class: "h-8 w-8 rounded-lg bg-slate-900/60 object-contain p-1" %>
            <div>
              <p class="font-semibold text-indigo-100 leading-tight"><%= @granted_chest_type.name %></p>
              <p class="text-xs text-indigo-200/80">Added to your inventory.</p>
            </div>
          </div>
          <span class="rounded-full bg-indigo-500 px-2 py-0.5 text-xs font-bold text-white">
            +1 (Total: <%= @granted_container&.count.to_i %>)
          </span>
        </div>
      <% end %>
    </div>
    <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-right space-y-1">
      <p class="text-xs font-semibold uppercase text-slate-500">Slot Cooldown</p>
      <% if cooldown_seconds.positive? %>
        <p class="text-sm font-semibold text-slate-700">
          Rescout available in <%= distance_of_time_in_words(Time.current, cooldown_seconds.seconds.from_now) %>
        </p>
      <% else %>
        <p class="text-sm font-semibold text-emerald-600">Rescout available now</p>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="rounded-xl border border-slate-100 bg-slate-50 p-5 space-y-4">
      <h3 class="text-sm font-semibold text-slate-500 uppercase">Party Summary</h3>
      <p class="text-sm text-slate-600 leading-relaxed">
        Each companion gained
        <span class="font-semibold text-indigo-600"><%= " #{@reward} EXP" %></span>
        from this expedition.
      </p>
      <p class="text-sm text-slate-600 leading-relaxed">
        You earned
        <span class="font-semibold text-amber-500"><%= " #{@coin_reward} Coins" %></span>.
      </p>
      <% if @diamond_reward.to_i.positive? %>
        <p class="text-sm text-slate-600 leading-relaxed">
          You also earned
          <span class="font-semibold text-emerald-600"><%= " #{@diamond_reward} Diamonds" %></span>.
        </p>
      <% end %>

      <% if @user_pets.any? %>
        <div class="space-y-3">
          <% @user_pets.each do |pet| %>
            <% sprite =
                 if defined?(pet_sprite_path)
                   pet_sprite_path(pet.pet)
                 else
                   asset_path("pets/#{pet.pet.name.parameterize}.png")
                 end %>
            <div class="flex items-center justify-between rounded-lg bg-white px-4 py-3 shadow-sm">
              <div class="flex items-center gap-3">
                <img class="h-10 w-10 rounded-full object-cover" alt="<%= pet.pet.name %>" src="<%= sprite %>" />
                <div>
                  <p class="text-sm font-semibold text-slate-800"><%= pet.name.presence || pet.pet.name %></p>
                  <p class="text-xs text-slate-500 flex items-center gap-2">
                    <span class="inline-flex items-center gap-1">
                      <span class="font-semibold">Level</span>
                      <%= pet.level %>
                    </span>
                    <span class="inline-flex items-center gap-1">
                      <span class="font-semibold">EXP</span>
                      <%= "#{pet.exp} / #{UserPet::EXP_PER_LEVEL}" %>
                    </span>
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-slate-500">No pets participated in this expedition.</p>
      <% end %>
    </div>

    <div class="rounded-xl border border-slate-100 bg-white p-5 space-y-4">
      <h3 class="text-sm font-semibold text-slate-500 uppercase">Containers Granted</h3>
      <% if @granted_chest_type.present? %>
        <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
          <div class="flex items-center gap-3">
            <%= image_tag asset_path(@granted_chest_type.icon),
                          alt: @granted_chest_type.name,
                          class: "h-10 w-10 rounded-lg bg-slate-900/60 object-contain p-1" %>
            <div>
              <p class="text-sm font-semibold text-slate-800"><%= @granted_chest_type.name %></p>
              <p class="text-xs text-slate-500">Claim it from your inventory to reveal rewards.</p>
            </div>
          </div>
          <span class="text-xs font-semibold text-slate-500 uppercase">Count: <%= @granted_container&.count.to_i %></span>
        </div>
      <% else %>
        <p class="text-sm text-slate-500">No containers granted for this expedition.</p>
      <% end %>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pt-3 border-t border-slate-100">
    <p class="text-xs text-slate-500">
      Expeditions gain extra rewards when party compositions fulfill special requirements.
    </p>
    <% if cooldown_seconds.positive? %>
      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-semibold text-slate-600">
        Rescout ready in <%= distance_of_time_in_words(Time.current, cooldown_seconds.seconds.from_now) %>
      </span>
    <% else %>
      <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-4 py-2 text-xs font-semibold text-emerald-600">
        Slot is ready to scout again
      </span>
    <% end %>
  </div>
</div>
