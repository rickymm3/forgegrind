<% generated = @selected_generated %>
<% world = generated.world %>
<% metadata = generated.metadata || {} %>
<% flavor = metadata[:flavor] || metadata["flavor"] %>
<% world_description = Array(flavor).compact.first %>
<% duration_seconds = generated.duration_seconds.to_i %>
<% duration_label = exploration_duration_label(duration_seconds) %>
<% rarity_label = metadata[:rarity_label] || metadata["rarity_label"] %>
<% rarity_color = metadata[:rarity_color] || metadata["rarity_color"] %>

<% subtitle_text = world_description.presence || "Scout this zone to earn rewards and uncover encounters." %>
<% duration_badge = content_tag(:div, duration_label, class: "page-badge page-badge--neutral") %>
<% rarity_badge = nil %>
<% if rarity_label.present? %>
  <% rarity_style = rarity_color ? "border-color: #{rarity_color}55; background-color: #{rarity_color}1a; color: #{rarity_color};" : nil %>
  <% rarity_icon = '<svg class="page-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 3l2.5 6.5L21 10l-5 4.5L17.5 21 12 17.5 6.5 21 8 14.5 3 10l6.5-.5L12 3z" stroke-linecap="round" stroke-linejoin="round" /></svg>'.html_safe %>
  <% rarity_badge = content_tag(:div, class: "page-badge", style: rarity_style) do %>
    <%= safe_join([rarity_icon, rarity_label]) %>
  <% end %>
<% end %>
<% meta_stack = content_tag(:div, class: "page-header__meta-stack") do %>
  <%= safe_join([duration_badge, rarity_badge].compact) %>
<% end %>

<% content_for :header do %>
  <%= render "shared/page_header",
             title: generated.name,
             subtitle: subtitle_text,
             back_path: explorations_path,
             back_label: "Back to explorations",
             right: meta_stack %>
<% end %>

<% equipped_pets = current_user.user_pets.equipped %>
<% if equipped_pets.any? %>
  <%= render "explorations/pet_camp", user_pets: equipped_pets %>
<% end %>

<% can_rescout = @selected_generated &&
                 !@selected_generated.consumed? &&
                 (@user_exploration.blank? || @user_exploration.complete?) &&
                 @selected_generated.slot_state_sym != :cooldown %>
<% if can_rescout %>
  <% reroll_seconds = @selected_generated.reroll_cooldown_remaining_seconds %>
  <% reroll_disabled = reroll_seconds.positive? %>
  <% reroll_wait = nil %>
  <% if reroll_disabled %>
    <% available_time = @selected_generated.reroll_available_at || (Time.current + reroll_seconds.seconds) %>
    <% reroll_wait = distance_of_time_in_words(Time.current, available_time) %>
  <% end %>
  <div class="zone-rescout">
    <%= button_to "Rescout Expedition",
                  reroll_exploration_path(@selected_generated),
                  method: :post,
                  class: "zone-rescout__button",
                  disabled: reroll_disabled,
                  form: { data: { turbo_confirm: "Replace this expedition with a fresh route?", turbo_frame: "_top" } } %>
    <% if reroll_wait.present? %>
      <p class="zone-rescout__note">Available in <%= reroll_wait %></p>
    <% end %>
  </div>
<% end %>

<div class="flex-1 w-full zone-content">
  <div class="mx-auto w-full max-w-4xl px-4 pb-28">
    <%= render "explorations/zone_card",
               generated_exploration: generated,
               user_exploration: @user_exploration,
               requirement_progress: @requirement_progress,
               requirement_groups: @requirement_groups,
               available_pets: @available_pets,
               selected_pet_ids: @selected_pet_ids,
               filters: @filters,
               state: @zone_state,
               show_filters: false,
               compact_layout: true %>
  </div>
</div>
