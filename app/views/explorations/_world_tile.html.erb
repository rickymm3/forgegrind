<% generated          = generated_exploration %>
<% user_exploration  ||= nil %>
<% slot_index        ||= nil %>
<% selected          = !!selected %>
<% state             = (state || (generated ? generated.slot_state_sym : :empty)).to_sym %>
<% cooldown_seconds  = (cooldown_seconds || generated&.cooldown_remaining_seconds || 0).to_i %>
<% slot_label        = slot_index ? "Slot #{slot_index}" : nil %>
<% format_countdown  = ->(value) { value = value.to_i; minutes = value / 60; seconds = value % 60; format("%02d:%02d", minutes, seconds) } %>

<% metadata     = generated&.metadata || {} %>
<% rarity_label = metadata["rarity_label"] || metadata[:rarity_label] %>
<% rarity_color = metadata["rarity_color"] || metadata[:rarity_color] %>

<% card_state_classes = selected ? "border-indigo-400/70 bg-slate-900/70" : "border-slate-800 bg-slate-950/70" %>

<% if generated.nil? || state == :empty %>
  <%= button_to scout_explorations_path,
                method: :post,
                data: { turbo_frame: "_top" },
                class: "w-full" do %>
    <div class="flex w-full flex-col gap-3 rounded-2xl border border-dashed border-indigo-500/40 bg-slate-900/50 px-4 py-5 text-left text-slate-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
          <span><%= slot_label || "Slot" %></span>
          <span>Inactive</span>
        </div>
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-indigo-500/20 text-indigo-200">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </span>
      </div>
      <p class="text-sm text-slate-300">No expedition assigned. Tap to scout a new route.</p>
    </div>
  <% end %>
<% elsif state == :cooldown %>
  <div class="flex w-full flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-5 text-slate-200">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
        <span><%= slot_label || "Slot" %></span>
        <span>Rescout cooling down</span>
      </div>
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-800 text-slate-300">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </span>
    </div>
    <% if cooldown_seconds.positive? %>
      <p class="text-sm text-slate-400"
         data-controller="slot-countdown"
         data-slot-countdown-seconds-value="<%= cooldown_seconds %>"
         data-slot-countdown-refresh-url-value="<%= explorations_path(format: :turbo_stream) %>">
        Ready to scout in
        <span class="font-semibold text-slate-200" data-slot-countdown-target="output"><%= format_countdown.call(cooldown_seconds) %></span>
      </p>
    <% else %>
      <p class="text-sm text-slate-400">Scouts returning shortly…</p>
    <% end %>
  </div>
<% else %>
  <% duration_label = exploration_duration_label(generated.duration_seconds) %>
  <% world          = generated.world %>
  <% segment_status = user_exploration.present? ? expedition_segment_status(user_exploration) : nil %>

  <% link_classes = "flex w-full flex-col gap-3 rounded-2xl border px-4 py-5 transition hover:border-indigo-400/70 hover:bg-slate-900/70 #{card_state_classes}" %>

  <%= link_to zone_explorations_path(id: generated.id),
              class: link_classes,
              data: { turbo_frame: "_top" } do %>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
        <span><%= slot_label || "Slot" %></span>
        <span><%= user_exploration.present? ? "Exploring" : "Ready to start" %></span>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 rounded-full bg-indigo-500/15 px-3 py-1 text-[11px] font-semibold uppercase text-indigo-200">
          <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
            <path d="M12 5v7l3 2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <%= duration_label %>
        </span>
        <% if rarity_label %>
          <span class="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase"
                style="<%= rarity_color ? "border-color: #{rarity_color}55; background-color: #{rarity_color}1a; color: #{rarity_color};" : '' %>">
            <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M12 3l2.5 6.5L21 10l-5 4.5L17.5 21 12 17.5 6.5 21 8 14.5 3 10l6.5-.5L12 3z" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <%= rarity_label %>
          </span>
        <% end %>
      </div>
    </div>

    <div>
      <h3 class="text-lg font-semibold text-white"><%= generated.name %></h3>
      <p class="mt-1 flex flex-wrap items-center gap-3 text-sm text-slate-300">
        <span class="inline-flex items-center gap-1">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 12h3m12 0h3M12 3v3m0 12v3" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span><%= world.name %></span>
        </span>
      </p>
    </div>

    <% if user_exploration.present? %>
      <div class="flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <% pets = user_exploration.user_pets.includes(:pet) %>
          <div class="flex -space-x-2">
            <% pets.each do |pet| %>
              <% sprite = defined?(pet_sprite_path) ? pet_sprite_path(pet.pet) : asset_path("pets/#{pet.pet.name.parameterize}.png") rescue nil %>
              <%= link_to user_pet_path(pet),
                          class: "relative inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-800 bg-slate-900 text-xs font-semibold text-slate-200 shadow hover:border-indigo-400",
                          data: { turbo_frame: "_top" } do %>
                <% if sprite.present? %>
                  <img src="<%= sprite %>" alt="<%= pet.name.presence || pet.pet.name %>" class="h-full w-full rounded-full object-cover" />
                <% else %>
                  <span class="px-2 text-[10px] uppercase tracking-wide"><%= pet.pet.name.first(3) %></span>
                <% end %>
              <% end %>
            <% end %>
          </div>

          <% if segment_status&.dig(:state) == :checkpoint %>
            <span class="text-xs font-semibold text-amber-300">Checkpoint reached — open to continue</span>
          <% elsif user_exploration.active_encounter? %>
            <span class="text-xs font-semibold text-amber-300">Encounter active</span>
          <% elsif segment_status&.dig(:state) == :active %>
            <span class="text-xs text-indigo-300"
                  data-controller="slot-countdown"
                  data-slot-countdown-seconds-value="<%= segment_status[:remaining_seconds] %>"
                  data-slot-countdown-refresh-url-value="<%= explorations_path(format: :turbo_stream) %>"
                  <%= %(data-slot-countdown-end-at-value="#{segment_status[:end_time].iso8601}") if segment_status[:end_time].respond_to?(:iso8601) %>>
              Next checkpoint in
              <span class="font-semibold text-indigo-100" data-slot-countdown-target="output">
                <%= exploration_duration_label(segment_status[:remaining_seconds]) %>
              </span>
            </span>
          <% else %>
            <span class="text-xs text-slate-400">Exploration underway</span>
          <% end %>
        </div>
      </div>
    <% else %>
      <% flavor = metadata["flavor"] || metadata[:flavor] %>
      <% if flavor.present? %>
        <p class="text-sm text-slate-400"><%= Array(flavor).compact.first %></p>
      <% end %>
    <% end %>
  <% end %>
<% end %>
