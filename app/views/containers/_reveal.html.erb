<% chest_hash = payload["chest_type"] || {} %>
<% chest = container_lookup&.dig(chest_hash["key"])&.chest_type || ChestType.find_by(key: chest_hash["key"]) %>
<% remaining_count = payload["remaining_count"].to_i %>
<% rewards = Array(payload["rewards"]) %>

<div class="fixed inset-0 z-50 flex items-center justify-center"
     data-controller="container-reveal">
  <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm"
       data-action="click->container-reveal#close"
       data-container-reveal-target="overlay"></div>

  <div class="relative z-10 w-full max-w-xl rounded-3xl border border-indigo-500/40 bg-slate-900/95 p-6 shadow-2xl space-y-6"
       data-container-reveal-target="dialog"
       data-action="click->container-reveal#stopPropagation"
       role="dialog"
       aria-modal="true"
       aria-labelledby="container-reveal-title"
       tabindex="-1">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-indigo-300">Rewards Revealed</p>
        <h3 id="container-reveal-title" class="text-2xl font-bold text-slate-50"><%= chest_hash["name"] %></h3>
        <p class="text-xs text-slate-400">
          Opened <span class="font-semibold text-indigo-200"><%= payload["opened"] %></span> container<%= "s" if payload["opened"].to_i > 1 %>.
        </p>
      </div>
      <button type="button"
              class="text-slate-400 hover:text-slate-200 transition"
              data-action="click->container-reveal#close"
              data-container-reveal-target="closeButton"
              aria-label="Close rewards modal">
        ✕
      </button>
    </div>

    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
      <% if rewards.blank? %>
        <div class="rounded-xl border border-slate-700/60 bg-slate-900/60 px-4 py-3 text-sm text-slate-300">
          Nothing found this time. Better luck on the next box!
        </div>
      <% else %>
        <% rewards.each do |reward| %>
          <% is_currency = reward["currency"].present? %>
          <% display_name = reward["name"].presence || reward["currency"].to_s.titleize %>
          <% amount = reward["qty"].to_i %>
          <% qty_label = is_currency ? "+#{number_with_delimiter(amount)}" : "x#{amount}" %>
          <% symbol = reward["symbol"].presence || (is_currency ? "¤" : nil) %>
          <div class="flex items-center justify-between rounded-xl border border-slate-700/60 bg-slate-900/60 px-4 py-3">
            <div class="flex items-center gap-3">
              <% if is_currency %>
                <div class="h-10 w-10 rounded-lg bg-emerald-600/10 text-emerald-300 flex items-center justify-center text-lg font-semibold">
                  <%= symbol %>
                </div>
              <% elsif reward["icon"].present? %>
                <img alt="<%= display_name %>" src="<%= reward["icon"] %>" class="h-10 w-10 rounded-lg bg-slate-800/80 object-contain p-2">
              <% else %>
                <div class="h-10 w-10 rounded-lg bg-slate-800/80 flex items-center justify-center text-slate-500 text-xs uppercase">Item</div>
              <% end %>
              <div>
                <p class="text-sm font-semibold text-slate-100"><%= display_name %></p>
                <p class="text-xs uppercase tracking-wide text-<%= rarity_color_class(reward["rarity"]) %>">
                  <%= is_currency ? "Currency" : reward["rarity"].to_s.titleize %>
                </p>
              </div>
            </div>
            <span class="text-sm font-semibold <%= is_currency ? 'text-emerald-300' : 'text-slate-200' %>"><%= qty_label %></span>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3">
      <p class="text-xs text-slate-400">
        Remaining: <span class="font-semibold text-indigo-200"><%= remaining_count %></span>
      </p>
      <div class="flex flex-wrap gap-2"
           data-action="click->container-reveal#stopPropagation">
        <% if chest.present? && payload["opened"].to_i > 0 %>
          <% open_again_disabled = remaining_count < payload["opened"].to_i || (!chest.open_batch_allowed? && payload["opened"].to_i > 1) %>
          <%= render "inventories/container_open_form",
                     chest: chest,
                     quantity: payload["opened"],
                     label: "Open Again",
                     css: "inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400",
                     disabled: open_again_disabled %>
        <% end %>
        <button type="button"
                class="inline-flex items-center gap-2 rounded-lg bg-slate-800 px-3 py-1.5 text-xs font-semibold text-slate-200 transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500"
                data-action="click->container-reveal#close"
                data-container-reveal-target="closeButton">
          Done
        </button>
      </div>
    </div>
  </div>
</div>
