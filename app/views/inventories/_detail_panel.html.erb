<% state ||= :idle %>
<% close_path ||= container_panel_inventory_path %>
<% visible = state.to_sym != :idle %>
<% sheet_style = "bottom: calc(env(safe-area-inset-bottom, 0px) + 5.5rem);" %>
<% sheet_classes = ["fixed", "left-0", "right-0", "z-50", "px-4", "transition-all", "duration-200", "ease-out", (visible ? "opacity-100 translate-y-0" : "opacity-0 translate-y-6 pointer-events-none")] %>
<% overlay_classes = ["fixed", "inset-0", "z-40", "bg-slate-950/70", "backdrop-blur-sm", "transition-opacity", "duration-200", "ease-out", (visible ? "opacity-100" : "opacity-0 pointer-events-none")] %>

<% if visible %>
  <div data-controller="action-panel">
    <%= form_with url: close_path,
                  method: :post,
                  data: { turbo_frame: "inventory-detail-panel", "action-panel-target": "cancelForm" },
                  class: "hidden" do |form| %>
      <%= form.hidden_field :cancel, value: 1 %>
    <% end %>

    <button type="button"
            class="<%= overlay_classes.join(' ') %>"
            data-action="action-panel#submitCancel"
            aria-label="Close inventory sheet"></button>

    <div class="<%= sheet_classes.join(' ') %>" style="<%= sheet_style %>" aria-hidden="false">
      <div class="pointer-events-auto mx-auto max-w-3xl rounded-3xl border border-slate-800 bg-slate-950/95 p-5 shadow-2xl shadow-slate-950/50 space-y-6">
        <% case state.to_sym %>
        <% when :container %>
          <% chest = local_assigns.fetch(:chest) %>
          <% container_count = local_assigns.fetch(:container_count, 0).to_i %>
          <% frame_class = chest_frame_class(chest) %>
          <header class="flex items-start justify-between gap-4">
            <div class="flex items-start gap-4">
              <div class="relative">
                <% icon_path = chest_icon_path(chest) %>
                <div class="relative aspect-square h-24 w-24 overflow-hidden rounded-3xl border-2 <%= frame_class %> bg-slate-900/80">
                  <% if icon_path.present? %>
                    <%= image_tag icon_path,
                                  alt: "",
                                  class: "absolute inset-0 h-full w-full object-contain p-4" %>
                  <% else %>
                    <div class="absolute inset-0 flex items-center justify-center text-sm text-slate-300">No Art</div>
                  <% end %>
                </div>
                <span class="absolute -bottom-2 -right-2 inline-flex items-center rounded-full bg-indigo-600 px-3 py-1 text-xs font-semibold text-white shadow-lg shadow-indigo-900/40">
                  x<%= container_count %>
                  <span class="sr-only">containers owned</span>
                </span>
              </div>
              <div class="space-y-1">
                <h2 class="text-lg font-semibold text-slate-100"><%= chest.name %></h2>
                <p class="text-xs text-slate-400 uppercase tracking-wide">Min Level <%= chest.min_level %></p>
                <p class="text-xs text-slate-400 leading-relaxed max-w-sm">
                  Open this container to reveal pet-care supplies and rare bonuses.
                </p>
              </div>
            </div>
            <button type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-700/70 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                    data-action="action-panel#submitCancel">
              Exit
            </button>
          </header>

          <div class="grid gap-3 sm:grid-cols-3">
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Availability</p>
              <p class="mt-1 text-sm font-semibold text-indigo-200"><%= container_count %> in inventory</p>
              <p class="mt-1 text-[11px] text-slate-400">Earn more by completing explorations.</p>
            </div>
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Loot Table</p>
              <% loot_table = chest.default_loot_table %>
              <% if loot_table.present? %>
                <p class="mt-1 text-sm font-semibold text-emerald-200"><%= loot_table.name %></p>
                <p class="mt-1 text-[11px] text-slate-400">Rolls between <%= loot_table.rolls_min %> and <%= loot_table.rolls_max %> rewards.</p>
              <% else %>
                <p class="mt-1 text-sm text-slate-400">No loot table configured.</p>
              <% end %>
            </div>
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Notes</p>
              <ul class="mt-1 space-y-1">
                <li class="flex items-center gap-2">
                  <span class="text-indigo-300">•</span>
                  <span>Rewards include pet care consumables and bonus currency.</span>
                </li>
                <li class="flex items-center gap-2">
                  <span class="text-indigo-300">•</span>
                  <span>Batch opening available when you own enough boxes.</span>
                </li>
              </ul>
            </div>
          </div>

          <div class="space-y-2">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Quick Open</p>
            <div class="flex flex-wrap gap-2"
                 data-action="click->inventory#rememberRevealTrigger">
              <%= render "inventories/container_open_form",
                         chest: chest,
                         quantity: 1,
                         label: "Open",
                         css: "inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                         disabled: container_count.zero? %>

              <% if chest.open_batch_allowed? && container_count >= 5 %>
                <%= render "inventories/container_open_form",
                           chest: chest,
                           quantity: 5,
                           label: "Open ×5",
                           css: "inline-flex items-center gap-2 rounded-full bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                           disabled: container_count < 5 %>
              <% end %>

              <% if chest.open_batch_allowed? && container_count > 1 %>
                <%= render "inventories/container_open_form",
                           chest: chest,
                           quantity: container_count,
                           label: "Open All",
                           css: "inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                           disabled: container_count.zero? %>
              <% end %>
            </div>
          </div>

        <% when :item %>
          <% user_item = local_assigns.fetch(:user_item) %>
          <% item = local_assigns.fetch(:item) %>
          <% metadata = local_assigns.fetch(:metadata, {}) %>
          <% rarity = metadata[:rarity].presence || "common" %>
          <% frame_class = rarity_frame_class(rarity) %>
          <% usable = metadata[:usable] %>
          <% icon_path = care_item_image_path(item.item_type) %>
          <header class="flex items-start justify-between gap-4">
            <div class="flex items-start gap-4">
              <div class="relative">
                <div class="relative aspect-square h-24 w-24 overflow-hidden rounded-3xl border-2 <%= frame_class %> bg-slate-900/80">
                  <% if icon_path.present? %>
                    <%= image_tag icon_path, alt: "", class: "absolute inset-0 h-full w-full object-contain p-4" %>
                  <% else %>
                    <div class="absolute inset-0 flex items-center justify-center text-sm text-slate-300">No Art</div>
                  <% end %>
                </div>
                <span class="absolute -bottom-2 -right-2 inline-flex items-center rounded-full bg-emerald-600 px-3 py-1 text-xs font-semibold text-white shadow-lg shadow-emerald-900/40">
                  x<%= user_item.quantity %>
                  <span class="sr-only">quantity</span>
                </span>
              </div>
              <div class="space-y-1">
                <h2 class="text-lg font-semibold text-slate-100"><%= item.name %></h2>
                <p class="text-xs uppercase tracking-wide text-<%= rarity_color_class(rarity) %>"><%= rarity.titleize %></p>
                <p class="text-xs text-slate-400 leading-relaxed max-w-sm">
                  <%= metadata[:description].presence || item_description(item) || "A useful item for caring for your companions." %>
                </p>
              </div>
            </div>
            <button type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-700/70 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                    data-action="action-panel#submitCancel">
              Exit
            </button>
          </header>

          <div class="grid gap-3 sm:grid-cols-3">
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Stack Count</p>
              <p class="mt-1 text-sm font-semibold text-emerald-200"><%= user_item.quantity %> available</p>
              <p class="mt-1 text-[11px] text-slate-400">Consumable charges will decrease when used.</p>
            </div>
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Category</p>
              <p class="mt-1 text-sm font-semibold text-slate-200"><%= item.item_type.to_s.humanize %></p>
              <p class="mt-1 text-[11px] text-slate-400">Unlocked via Pet Care boxes and events.</p>
            </div>
            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
              <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Usage</p>
              <% if usable %>
                <p class="mt-1 text-[11px] text-slate-400">Select a companion to apply this item directly from your inventory.</p>
              <% else %>
                <p class="mt-1 text-[11px] text-slate-400">This item is used automatically during care interactions.</p>
              <% end %>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3">
            <% if usable %>
              <button type="button"
                      class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 cursor-not-allowed opacity-70"
                      disabled>
                Use Item (Coming Soon)
              </button>
            <% else %>
              <span class="text-[11px] text-slate-400">Use pet interactions to consume this item.</span>
            <% end %>
          </div>

        <% else %>
          <div class="text-center text-xs text-slate-400">
            Select a container or item to view details.
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="pointer-events-none opacity-0 translate-y-6 transition-all duration-200 ease-out" aria-hidden="true"></div>
<% end %>
