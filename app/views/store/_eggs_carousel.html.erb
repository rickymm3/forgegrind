<% highlighted_egg_id = local_assigns[:highlighted_egg_id] %>

<% if eggs.any? %>
  <div class="space-y-4">
    <div class="flex w-full flex-wrap items-center justify-between gap-3">
      <div>
        <h2 class="text-xl font-semibold text-slate-100">Available eggs</h2>
        <p class="text-sm text-slate-400">Top-to-bottom lineupâ€”no swiping needed. Each shell hides a surprise companion.</p>
      </div>
      <%= link_to "View nursery",
                  pets_path(view: "eggs"),
                  class: "inline-flex items-center gap-2 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-indigo-100 transition hover:bg-indigo-500/20 shrink-0" %>
    </div>

    <div class="grid grid-cols-1 gap-5 lg:grid-cols-2 xl:grid-cols-3">
      <% eggs.each do |egg| %>
        <% image_path   = egg_image_path(egg) %>
        <% highlight    = highlighted_egg_id.present? && highlighted_egg_id == egg.id %>
        <% can_afford   = current_user.can_afford_egg?(egg) rescue true %>
        <% afford_label = can_afford ? "Ready to adopt" : "Need more currency" %>
        <% border_class = highlight ? "border-emerald-400/70 ring-2 ring-emerald-400/30 shadow-emerald-400/30" : "border-slate-800/80 hover:border-indigo-500/40" %>

        <article class="egg-card group relative flex h-full flex-col overflow-hidden rounded-3xl border bg-slate-950/70 shadow-inner shadow-slate-950/40 transition <%= border_class %>">
          <div class="egg-card__media relative w-full overflow-hidden bg-slate-900 flex items-center justify-center"
               style="height: clamp(200px, 32vh, 300px);">
            <% if image_path.present? %>
              <%= image_tag image_path,
                            alt: "#{egg.name} egg",
                            class: "max-h-full max-w-full object-contain transition duration-300 group-hover:scale-105" %>
            <% else %>
              <div class="flex h-full w-full items-center justify-center text-sm text-slate-500">Artwork pending</div>
            <% end %>
            <% if highlight %>
              <div class="egg-card__banner absolute inset-x-0 top-0 flex justify-center">
                <span class="mt-3 inline-flex w-[90%] items-center justify-center rounded-full bg-emerald-500/95 px-4 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-950 shadow-lg shadow-emerald-500/30">
                  Featured
                </span>
              </div>
            <% end %>
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/80 via-slate-950/10 to-transparent"></div>
            <div class="egg-card__overlay absolute inset-x-0 top-0 flex flex-col gap-2 px-4 pt-4">
              <div class="egg-card__header flex items-start justify-between gap-3">
                <h3 class="text-lg font-semibold text-white drop-shadow"><%= egg.name %></h3>
                <% if egg.currency && egg.cost_amount.to_i.positive? %>
                  <span class="inline-flex items-center gap-1 text-sm font-semibold <%= can_afford ? 'text-indigo-50' : 'text-amber-200' %>">
                    ðŸ’Ž <%= egg.cost_amount %>
                  </span>
                <% end %>
              </div>
            </div>
            <span class="egg-card__status absolute bottom-3 right-3 inline-flex w-fit items-center gap-2 rounded-full border border-slate-800 bg-slate-900/90 px-3 py-1 text-[11px] font-semibold text-slate-200"><%= afford_label %></span>
          </div>

          <div class="egg-card__body flex flex-1 flex-col gap-4 p-5">
            <% if egg.egg_item_costs.any? %>
              <details class="rounded-2xl border border-slate-800/70 bg-slate-950/60 px-3 py-2 text-xs text-slate-300">
                <summary class="cursor-pointer text-xs font-semibold text-slate-200">Required items</summary>
                <ul class="mt-2 space-y-1">
                  <% egg.egg_item_costs.includes(:item).each do |cost| %>
                    <li class="flex items-center justify-between text-[11px] text-slate-400">
                      <span><%= cost.item.name %></span>
                      <span class="font-semibold text-slate-200">x<%= cost.quantity %></span>
                    </li>
                  <% end %>
                </ul>
              </details>
            <% else %>
              <p class="text-sm text-slate-400">No extra items required.</p>
            <% end %>

            <div class="mt-auto">
              <%= form_with url: user_eggs_path,
                            method: :post,
                            data: { controller: "loading-button", action: "turbo:submit-start->loading-button#start turbo:submit-end->loading-button#stop" },
                            class: "space-y-2" do |f| %>
                <%= hidden_field_tag :egg_id, egg.id %>
                <%= hidden_field_tag :origin, "store" %>
                <% unless can_afford %>
                  <p class="text-[11px] text-amber-300">You need more resources to adopt this egg.</p>
                <% end %>
                <% button_classes = if can_afford
                                      "w-full inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                                    else
                                      "w-full inline-flex items-center justify-center gap-2 rounded-xl border border-slate-700/60 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-500 cursor-not-allowed"
                                    end %>
                <%= f.button "Adopt",
                             type: :submit,
                             class: button_classes,
                             disabled: !can_afford,
                             data: { "loading-button-target": "button" } %>
              <% end %>
            </div>
          </div>
        </article>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="rounded-3xl border border-slate-800 bg-slate-950/70 p-8 text-center text-slate-300">
    <h2 class="text-xl font-semibold text-slate-100">No eggs available right now</h2>
    <p class="mt-2 text-sm">Check back soonâ€”new clutches arrive throughout the week.</p>
  </div>
<% end %>
