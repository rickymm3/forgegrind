<% generated = generated_exploration %>
<% user_exploration ||= nil %>
<% state = (local_assigns[:state] || :selection).to_sym %>
<% requirement_progress ||= [] %>
<% requirement_groups ||= {} %>
<% available_pets ||= [] %>
<% selected_pet_ids ||= [] %>
<% filters ||= {} %>
<% filters_hash =
     if filters.respond_to?(:to_unsafe_h)
       filters.to_unsafe_h
     elsif filters.respond_to?(:to_h)
       filters.to_h
     else
       filters || {}
     end %>
<% filters_hash = filters_hash.stringify_keys if filters_hash.respond_to?(:stringify_keys) %>
<% filters_hash = filters_hash.reject { |_k, value| value.blank? } if filters_hash.respond_to?(:reject) %>
<% filters_json = filters_hash.to_json %>
<% duration_seconds = generated.duration_seconds %>
<% duration_minutes = (duration_seconds / 60).floor %>
<% duration_remainder = duration_seconds % 60 %>
<% duration_label = [] %>
<% duration_label << "#{duration_minutes}m" unless duration_minutes.zero? %>
<% duration_label << "#{duration_remainder}s" %>
<% rarity_label = generated.metadata&.dig("rarity_label") %>
<% rarity_color = generated.metadata&.dig("rarity_color") %>
<% all_requirements_met = requirement_progress.present? && requirement_progress.all? { |entry| entry[:fulfilled] } %>
<% detail_dom_id = dom_id(generated, :detail) %>
<% show_filters = local_assigns.fetch(:show_filters, true) %>
<% compact_layout = local_assigns.fetch(:compact_layout, false) %>
<% slot_size_classes = compact_layout ? "h-14 w-14" : "h-20 w-20" %>
<% slot_avatar_placeholder_class = compact_layout ? "text-lg" : "text-xl" %>
<% card_avatar_classes = compact_layout ? "h-12 w-12" : "h-16 w-16" %>
<% card_container_classes =
     if compact_layout
       ["rounded-3xl", "border", "border-slate-200", "bg-white", "shadow-sm", "overflow-hidden"]
     else
       ["card", "group", "relative", "rounded-2xl", "bg-white", "shadow-lg", "transition-shadow", "duration-200", "hover:shadow-xl", "overflow-hidden"]
     end %>
<% content_wrapper_classes = ["space-y-4", (compact_layout ? "p-4" : "p-5")] %>
<% preview_params = {} %>
<% preview_params[:compact_layout] = 1 if compact_layout %>
<% preview_params[:show_filters] = 0 unless show_filters %>
<% preview_url = preview_exploration_path(generated, preview_params) %>
<% pet_list_grid_classes =
     if compact_layout
       "grid grid-cols-1 gap-3 max-h-64 overflow-y-auto pr-1"
     else
       "grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-72 overflow-y-auto pr-1"
     end %>

<div class="<%= card_container_classes.join(' ') %>" id="<%= detail_dom_id %>">
  <% unless compact_layout %>
    <%= render "explorations/zone_card/header_hero",
               generated: generated,
               duration_label: duration_label,
               rarity_label: rarity_label,
               rarity_color: rarity_color %>
  <% end %>

  <div class="<%= content_wrapper_classes.join(' ') %>">

    <% segments = Array(generated.segment_definitions) %>
    <% checkpoint_count = segments.size %>
    <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-600">
      <span>Checkpoints</span>
      <% if checkpoint_count.positive? %>
        <div class="flex items-center gap-1">
          <% checkpoint_count.times do %>
            <span class="h-2 w-2 rounded-full bg-slate-500/80 inline-block"></span>
          <% end %>
        </div>
      <% else %>
        <span class="text-slate-400">None</span>
      <% end %>
    </div>

    <% case state %>
    <% when :selection %>
      <%= render "explorations/zone_card/selection_section",
                 generated: generated,
                 detail_dom_id: detail_dom_id,
                 selected_pet_ids: selected_pet_ids,
                 requirement_progress: requirement_progress %>

    <% when :active %>
      <% if user_exploration.using_segments? %>
        <%= render "explorations/zone_card/active_segmented",
                   user_exploration: user_exploration,
                   requirement_progress: requirement_progress %>
      <% else %>
        <%= render "explorations/zone_card/active_linear",
                   user_exploration: user_exploration,
                   rarity_label: rarity_label,
                   rarity_color: rarity_color,
                   requirement_progress: requirement_progress %>
      <% end %>

    <% when :checkpoint %>
      <%= render "explorations/zone_card/checkpoint_state",
                 user_exploration: user_exploration,
                 requirement_progress: requirement_progress %>

    <% when :ready %>
      <%= render "explorations/zone_card/ready_state",
                 generated: generated,
                 user_exploration: user_exploration %>
    <% end %>
  </div>
</div>
