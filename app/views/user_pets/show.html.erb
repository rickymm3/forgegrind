<% user_pet        = @user_pet %>
<% pet             = user_pet.pet %>
<% pet_name        = user_pet.name.presence || pet.name %>
<% rarity_name     = user_pet.rarity&.name || "Unknown" %>
<% sprite_path     = pet_sprite_path(pet) %>
<% pet_types       = pet.pet_types %>
<% default_ability = pet.respond_to?(:default_ability) ? pet.default_ability&.name : nil %>
<% ability_names   = user_pet.learned_abilities.limit(3).map(&:name).presence || [default_ability || "Basic Ability"] %>
<% xp_ratio        = (user_pet.exp.to_f / UserPet::EXP_PER_LEVEL).clamp(0.0, 1.0) %>
<% xp_percent      = (xp_ratio * 100).round(1) %>
<% state_badges    = pet_state_badges(user_pet) %>
<% exploring       = user_pet.exploring? %>
<% asleep_until    = user_pet.asleep_until %>
<% sleeping        = asleep_until.present? && Time.current < asleep_until %>
<% energy_ratio    = (user_pet.energy.to_f / UserPet::MAX_ENERGY).clamp(0.0, 1.0) %>
<% energy_percent  = (energy_ratio * 100).round(1) %>
<% can_level       = user_pet.exp.to_i >= UserPet::EXP_PER_LEVEL %>
<% maxed_level     = user_pet.level >= UserPet::LEVEL_CAP %>
<% level_up_disabled = maxed_level || exploring || sleeping || !can_level %>
<% actions_catalog = [
  { key: "play",   label: "Play",   emoji: "üéæ" },
  { key: "wash",   label: "Groom",  emoji: "üßº" },
  { key: "feed",   label: "Feed",   emoji: "üçñ" },
  { key: "treat",  label: "Treat",  emoji: "üíä" },
  { key: "cuddle", label: "Cuddle", emoji: "ü§ó" },
  { key: "walk",   label: "Walk",   emoji: "üß≠" }
].select { |action| PetCareService::ACTIONS.key?(action[:key]) } %>
<% care_metrics = [:hunger, :hygiene, :boredom, :injury_level, :mood].filter_map do |metric|
  next unless user_pet.respond_to?(metric)
  value   = user_pet.send(metric).to_f rescue nil
  next unless value
  percent = value.clamp(0.0, 100.0)
  {
    key: metric,
    label: need_label(metric),
    value: value.round(1),
    percent: percent.round(1)
  }
end %>

<% content_for :main_style, "padding-bottom: 0;" %>
<% content_for :main_class, "px-0 pt-4 flex flex-col" %>
<% content_for :main_inner_class, "px-4 flex flex-col h-full" %>

<% content_for :header do %>
  <div class="mx-auto flex w-full max-w-4xl items-center justify-between gap-4 px-4">
    <div class="flex items-center gap-3">
      <%= link_to user_pets_path,
                  class: "inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-800 bg-slate-900/70 text-slate-300 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950",
                  aria: { label: "Back to pets" },
                  data: { turbo: false } do %>
        <span aria-hidden="true" class="text-lg">‚Üê</span>
      <% end %>
      <div>
        <h1 class="text-2xl font-semibold text-white"><%= pet_name %></h1>
      </div>
    </div>
    <div class="inline-flex items-center gap-2 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-indigo-100">
      <span aria-hidden="true">‚òÖ</span>
      <%= rarity_name %>
    </div>
  </div>
<% end %>

<div class="relative flex flex-1 min-h-full flex-col bg-slate-950 text-slate-100"
     data-controller="pet-display"
     data-action="action-panel:preview->pet-display#handlePreview"
     data-pet-display-state-value="image">
  <main class="relative mx-auto flex-1 w-full max-w-4xl overflow-hidden px-4 pb-0 pt-4 sm:px-6">
    <div class="relative mx-auto flex h-full w-full items-center justify-center"
         style="height: clamp(20rem, 72vh, 34rem); max-width: clamp(18rem, 70vw, 32rem);">
      <button type="button"
              class="relative flex h-full w-full items-center justify-center"
              data-action="pet-display#toggle">
        <div class="relative h-full w-full overflow-hidden rounded-[2.5rem] border border-slate-800 bg-slate-900/80 shadow-[0_25px_60px_-20px_rgba(15,23,42,0.9)] transition duration-300 ease-out opacity-100 pointer-events-auto"
             data-pet-display-target="imagePanel">
          <div class="absolute inset-0 bg-gradient-to-b from-slate-900/50 via-slate-900/30 to-slate-950/60 mix-blend-multiply"></div>
          <div class="relative flex h-full w-full items-center justify-center">
            <% if sprite_path.present? %>
              <%= image_tag sprite_path,
                            alt: "",
                            loading: "lazy",
                            class: "h-full max-h-full w-auto max-w-full object-contain object-center" %>
            <% else %>
              <div class="flex h-full w-full items-center justify-center text-sm text-slate-400">
                Artwork unavailable
              </div>
            <% end %>
          </div>

          <div class="pointer-events-none absolute top-4 right-4 flex flex-col items-end gap-2 text-xs">
            <span class="inline-flex items-center gap-2 rounded-full border border-slate-700/60 bg-slate-950/80 px-3 py-1 font-semibold text-indigo-100 shadow-lg shadow-slate-950/30">
              Lvl <%= user_pet.level %>
            </span>
            <div class="w-40 rounded-full border border-slate-800/70 bg-slate-900/80 px-3 py-2 text-left shadow-lg shadow-slate-950/30">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-300">Experience</p>
              <div class="mt-1 h-2 w-full overflow-hidden rounded-full bg-slate-800">
                <div class="h-full rounded-full bg-indigo-500 transition-all" style="width: <%= xp_percent %>%"></div>
              </div>
              <p class="mt-1 text-[10px] text-slate-400"><%= user_pet.exp %> / <%= UserPet::EXP_PER_LEVEL %> XP</p>
            </div>
            <% state_badges.each do |badge| %>
              <span class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold shadow-lg shadow-slate-950/30 <%= badge[:class] %>"
                    <%= %(title="#{badge[:title]}") if badge[:title].present? %>>
                <%= badge[:label] %>
              </span>
            <% end %>
          </div>

          <div class="pointer-events-none absolute inset-x-0 bottom-0 bg-slate-950/80 px-6 pb-6 pt-4 text-sm backdrop-blur">
            <div class="flex flex-wrap items-center justify-between gap-3 text-[12px] font-semibold uppercase tracking-wide text-slate-200">
              <% if pet_types.any? %>
                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-3 py-1 text-emerald-100">
                  <span aria-hidden="true">üåø</span>
                  <%= pet_types.map(&:name).join(" ¬∑ ") %>
                </span>
              <% end %>
              <span class="inline-flex flex-1 items-center justify-end gap-2 rounded-full border border-slate-700/60 bg-slate-900/60 px-3 py-1 text-slate-200 sm:flex-none">
                <span aria-hidden="true">‚ú®</span>
                <%= ability_names.join(" ¬∑ ") %>
              </span>
            </div>
            <p class="mt-3 text-center text-[11px] text-slate-400">Tap anywhere to view care stats</p>
          </div>
        </div>

        <div class="absolute inset-0 flex flex-col justify-between rounded-[2.5rem] border border-slate-800 bg-slate-950/95 px-6 py-6 opacity-0 pointer-events-none transition duration-300 ease-out"
             data-pet-display-target="statsPanel">
          <div class="flex items-start justify-between gap-6">
            <div>
              <p class="text-[12px] font-semibold uppercase tracking-wide text-slate-400">Care Status</p>
              <h2 class="mt-1 text-xl font-semibold text-white"><%= pet_name %></h2>
            </div>
            <div class="text-right text-[11px] text-slate-400">
              <p data-pet-display-target="energyValue"
                 data-base-value="<%= user_pet.energy %>"
                 data-max-value="<%= UserPet::MAX_ENERGY %>">Energy
                <span class="font-semibold text-indigo-200">
                  <%= user_pet.energy %> / <%= UserPet::MAX_ENERGY %>
                </span>
              </p>
              <div class="mt-1 h-1.5 w-32 overflow-hidden rounded-full bg-slate-800">
                <div class="h-full rounded-full bg-emerald-500 transition-all"
                     data-pet-display-target="energyBar"
                     data-base-percent="<%= energy_percent %>"
                     data-max-value="<%= UserPet::MAX_ENERGY %>"
                     style="width: <%= energy_percent %>%"></div>
              </div>
            </div>
          </div>

          <div class="mt-4 flex flex-1 flex-col justify-between">
            <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-2">
              <% care_metrics.each do |metric| %>
                <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3"
                     data-pet-display-target="need"
                     data-key="<%= metric[:key] %>"
                     data-base-value="<%= metric[:value] %>"
                     data-base-percent="<%= metric[:percent] %>">
                  <div class="flex items-center justify-between text-[13px] font-semibold text-slate-100">
                    <span><%= metric[:label] %></span>
                    <span data-pet-display-target="needValue"
                          data-key="<%= metric[:key] %>"><%= metric[:value] %></span>
                  </div>
                  <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-slate-800">
                    <div class="h-full rounded-full bg-emerald-500 transition-all"
                         data-pet-display-target="needBar"
                         data-key="<%= metric[:key] %>"
                         style="width: <%= metric[:percent] %>%"></div>
                  </div>
                  <p class="mt-2 hidden text-[11px] font-semibold text-emerald-300"
                     data-pet-display-target="needDelta"
                     data-key="<%= metric[:key] %>"></p>
                </div>
              <% end %>
            </div>

            <div class="mt-6 space-y-3 text-sm text-slate-300">
              <div class="flex items-center justify-between rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3">
                <div>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Experience</p>
                  <p class="text-sm font-semibold text-slate-100"
                     data-pet-display-target="xpText"
                     data-base-before="<%= user_pet.exp %>"
                     data-base-after="<%= user_pet.exp %>"
                     data-max-value="<%= UserPet::EXP_PER_LEVEL %>"
                     data-base-text="<%= "#{user_pet.exp} / #{UserPet::EXP_PER_LEVEL} XP" %>">
                    <%= user_pet.exp %> / <%= UserPet::EXP_PER_LEVEL %> XP
                  </p>
                </div>
                <div class="flex flex-col items-end">
                  <div class="h-2 w-32 overflow-hidden rounded-full bg-slate-800">
                    <div class="h-full rounded-full bg-indigo-500 transition-all"
                         data-pet-display-target="xpBar"
                         data-base-percent="<%= xp_percent %>"
                         data-max-value="<%= UserPet::EXP_PER_LEVEL %>"
                         style="width: <%= xp_percent %>%"></div>
                  </div>
                  <span class="mt-1 text-[11px] text-slate-400"
                        data-pet-display-target="xpValue"
                        data-base-text="<%= number_to_percentage(xp_percent, precision: 1) %>"
                        data-base-percent="<%= xp_percent %>"><%= number_to_percentage(xp_percent, precision: 1) %></span>
                </div>
              </div>

              <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-[12px]">
                <span class="font-semibold text-slate-200">Level <%= user_pet.level %></span>
                <% if level_up_disabled %>
                  <span class="text-[11px] text-slate-500">
                    <% if maxed_level %>
                      Max level reached
                    <% elsif exploring %>
                      Unavailable while exploring
                    <% elsif sleeping %>
                      Resting ‚Äî check back soon
                    <% else %>
                      Earn <%= UserPet::EXP_PER_LEVEL - user_pet.exp.to_i %> more XP
                    <% end %>
                  </span>
                <% else %>
                  <%= form_with url: level_up_user_pet_path(user_pet),
                                method: :post,
                                data: { turbo_frame: "_top" },
                                class: "relative" do |f| %>
                    <%= f.button "Level Up",
                                 class: "inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-[11px] font-semibold uppercase tracking-wide text-white transition hover:bg-indigo-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950" %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <p class="mt-6 text-center text-[11px] text-slate-500">Tap anywhere to return to the portrait</p>
        </div>
      </button>
    </div>
  </main>

  <div class="fixed left-0 right-0 z-40 flex justify-center border-t border-slate-800 bg-slate-950/90 shadow-[0_-18px_40px_-28px_rgba(15,23,42,0.9)] backdrop-blur"
       style="bottom: calc(env(safe-area-inset-bottom, 0px) + 4.5rem); padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 0.5rem);">
    <div class="pointer-events-auto flex w-full max-w-4xl items-stretch gap-2 px-4">
      <% disabled_actions = exploring || sleeping %>
      <% actions_catalog.each do |action| %>
        <% definition = PetCareService::ACTIONS[action[:key]] %>
        <%= button_to interact_preview_user_pet_path(user_pet),
                      method: :post,
                      params: { interaction_type: action[:key], context: :page },
                      form: {
                        class: "flex flex-1 basis-0",
                        data: {
                          turbo_frame: action_panel_dom_id(user_pet),
                          "pet-display-target": "careForm"
                        }
                      },
                      disabled: disabled_actions,
                      class: "flex h-full w-full flex-col items-center gap-1 rounded-lg border border-slate-800/60 bg-slate-900/85 px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-slate-200 shadow-[0_12px_24px_-20px_rgba(15,23,42,0.85)] transition hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible-ring-offset-slate-950 disabled:cursor-not-allowed disabled:opacity-40",
                      title: action[:label],
                      aria: { label: "#{action[:label]} action" } do %>
          <span aria-hidden="true" class="text-lg leading-none"><%= action[:emoji] %></span>
          <span><%= action[:label] %></span>
          <% if definition[:energy_cost].to_i.positive? %>
            <span class="text-[10px] font-normal text-slate-400"><%= definition[:energy_cost] %> EN</span>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="fixed inset-x-0 bottom-0 pointer-events-none pb-20"></div>

  <%= render "user_pets/action_panel_frame",
             user_pet: user_pet,
             context: :page,
             state: :idle,
             needs_preview: [],
             personality_changes: [] %>
</div>
