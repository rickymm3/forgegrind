<% context       = (defined?(local_assigns) && local_assigns.fetch(:context, nil)) || :page %>
<% action_dom_id = (defined?(local_assigns) && local_assigns.fetch(:action_dom_id, nil)) || action_panel_dom_id(user_pet) %>
<% pet             = user_pet.pet %>
<% rarity_name     = user_pet.rarity&.name || "Unknown" %>
<% pet_types       = pet.pet_types %>
<% default_ability_name = pet.respond_to?(:default_ability) ? pet.default_ability&.name : nil %>
<% ability_names   = user_pet.learned_abilities.limit(3).map(&:name).presence || [default_ability_name || "Basic Ability"] %>
<% sprite_path     = pet_sprite_path(pet) %>
<% exploring       = user_pet.exploring? %>
<% asleep_until    = user_pet.asleep_until %>
<% sleeping        = asleep_until.present? && Time.current < asleep_until %>
<% actions_catalog = [
  { key: "play",   label: "Play",  emoji: "ğŸ¾" },
  { key: "wash",   label: "Groom", emoji: "ğŸ§¼" },
  { key: "feed",   label: "Feed",  emoji: "ğŸ–" },
  { key: "treat",  label: "Treat", emoji: "ğŸ’Š" },
  { key: "cuddle", label: "Cuddle", emoji: "ğŸ¤—" },
  { key: "walk",   label: "Walk",  emoji: "ğŸ§­" }
].select { |action| PetCareService::ACTIONS.key?(action[:key]) } %>

<div class="space-y-6">
  <div class="flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <%= link_to user_pets_path,
                  class: "inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-800 bg-slate-900/70 text-slate-300 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible-ring-offset-slate-950",
                  aria: { label: "Back to pets" },
                  data: { turbo: false } do %>
        <span aria-hidden="true" class="text-lg">â†</span>
      <% end %>
      <div>
        <h2 class="text-xl font-semibold text-slate-100"><%= user_pet.name.presence || pet.name %></h2>
        <span class="inline-flex items-center gap-2 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-100">
          <span aria-hidden="true">â˜…</span>
          <%= rarity_name %>
        </span>
      </div>
    </div>
  </div>

  <% if exploring %>
    <div class="rounded-2xl border border-amber-500/40 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
      <strong><%= user_pet.name.presence || pet.name %></strong> is exploring and unavailable for new activities until the run finishes.
    </div>
  <% elsif sleeping %>
    <% minutes_left = ((asleep_until - Time.current) / 60).ceil %>
    <div class="rounded-2xl border border-sky-500/40 bg-sky-500/10 px-4 py-3 text-sm text-sky-100">
      <strong><%= user_pet.name.presence || pet.name %></strong> is resting for another <%= pluralize(minutes_left, "minute") %>.
    </div>
  <% end %>

  <div class="relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/60 shadow-inner shadow-slate-950/40">
    <div class="aspect-[3/4] w-full bg-slate-900">
      <% if sprite_path.present? %>
        <%= image_tag sprite_path,
                      alt: "",
                      loading: "lazy",
                      class: "h-full w-full object-cover" %>
      <% else %>
        <div class="flex h-full w-full items-center justify-center text-sm text-slate-400">
          Artwork unavailable
        </div>
      <% end %>
    </div>
    <span class="absolute top-3 right-3 inline-flex items-center rounded-full bg-slate-950/85 px-3 py-1 text-xs font-semibold text-indigo-200 drop-shadow">
      Lvl <%= user_pet.level %>
    </span>
  </div>

  <div class="flex flex-wrap items-center gap-2">
    <span class="inline-flex items-center gap-1 rounded-full border border-slate-700/60 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-200">
      <span aria-hidden="true">ğŸ¯</span>
      Level <%= user_pet.level %>
    </span>
    <% if pet_types.any? %>
      <span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-200">
        <span aria-hidden="true">ğŸŒ¿</span>
        <%= pet_types.map(&:name).join(" Â· ") %>
      </span>
    <% end %>
    <span class="inline-flex items-center gap-1 rounded-full border border-slate-700/60 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-200">
      <span aria-hidden="true">âœ¨</span>
      <%= ability_names.join(" Â· ") %>
    </span>
  </div>

  <div class="space-y-4">
    <div class="flex flex-wrap gap-2">
      <% actions_catalog.each do |action| %>
        <% definition   = PetCareService::ACTIONS[action[:key]] %>
        <% disabled     = exploring || sleeping %>
        <%= button_to interact_preview_user_pet_path(user_pet),
                      method: :post,
                      params: { interaction_type: action[:key], context: context },
                      form: {
                        data: { turbo_frame: action_dom_id }
                      },
                      disabled: disabled,
                      class: "inline-flex h-14 w-14 flex-col items-center justify-center gap-1 rounded-2xl border border-slate-800 bg-slate-900/70 text-sm font-semibold text-slate-200 transition hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 disabled:opacity-40 disabled:cursor-not-allowed",
                      title: action[:label],
                      aria: { label: action[:label] } do %>
          <span aria-hidden="true" class="text-xl leading-none"><%= action[:emoji] %></span>
          <span class="text-[10px] uppercase tracking-wide text-slate-400"><%= action[:label] %></span>
        <% end %>
      <% end %>
    </div>

    <details class="group rounded-2xl border border-slate-800 bg-slate-900/60 p-4 text-sm text-slate-200">
      <summary class="flex cursor-pointer items-center justify-between text-sm font-semibold text-slate-100">
        More details
        <span class="text-xs text-slate-500 transition group-open:rotate-180">âŒƒ</span>
      </summary>
      <div class="mt-3 space-y-3 text-sm text-slate-300">
        <% if pet.description.present? %>
          <p class="text-slate-300"><%= pet.description %></p>
        <% end %>
        <% xp_ratio = user_pet.exp.to_f / UserPet::EXP_PER_LEVEL %>
        <% xp_ratio = [[xp_ratio, 0.0].max, 1.0].min %>
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Experience</p>
          <div class="mt-1 h-2 w-full overflow-hidden rounded-full bg-slate-800">
            <div class="h-full rounded-full bg-indigo-500 transition-all" style="width: <%= (xp_ratio * 100).round(1) %>%"></div>
          </div>
          <p class="mt-1 text-xs text-slate-500"><%= user_pet.exp %> / <%= UserPet::EXP_PER_LEVEL %> XP</p>
        </div>
        <% energy_ratio = user_pet.energy.to_f / UserPet::MAX_ENERGY %>
        <% energy_ratio = [[energy_ratio, 0.0].max, 1.0].min %>
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Energy</p>
          <div class="mt-1 h-2 w-full overflow-hidden rounded-full bg-slate-800">
            <div class="h-full rounded-full bg-emerald-500 transition-all" style="width: <%= (energy_ratio * 100).round(1) %>%"></div>
          </div>
          <div class="mt-1 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
            <span><%= "#{user_pet.energy} / #{UserPet::MAX_ENERGY}" %></span>
            <% if user_pet.energy.to_i >= UserPet::MAX_ENERGY %>
              <span class="font-semibold text-emerald-400">Fully rested</span>
            <% else %>
              <span class="flex items-center gap-1 text-indigo-200"
                    data-controller="countdown"
                    data-countdown-seconds-value="<%= user_pet.seconds_until_next_energy %>"
                    data-user-pet-id="<%= user_pet.id %>">
                Next energy in
                <span class="font-semibold text-indigo-100" data-countdown-target="output">â€”</span>
              </span>
            <% end %>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 text-xs text-slate-300">
          <% [:hunger, :hygiene, :boredom, :injury_level, :mood].each do |need| %>
            <% value = user_pet.send(need).to_i rescue nil %>
            <% next unless value %>
            <div class="rounded-xl border border-slate-800 bg-slate-900/60 px-3 py-2">
              <p class="font-semibold text-slate-200"><%= need_label(need) %></p>
              <p class="text-slate-400"><%= value %> / 100</p>
            </div>
          <% end %>
        </div>
      </div>
    </details>
  </div>

</div>
