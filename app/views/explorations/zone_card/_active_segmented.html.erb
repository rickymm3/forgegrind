<%# Active state for segmented explorations %>
<% segment_entries = user_exploration.segment_progress_entries.sort_by { |entry| entry[:index].to_i } %>
<% active_segment = user_exploration.active_segment_entry %>
<% ready_encounter = user_exploration.ready_encounter_entry %>
<% upcoming_encounter = user_exploration.upcoming_encounter_entry %>
<% total_duration = user_exploration.duration_seconds %>
<% elapsed_seconds = user_exploration.elapsed_seconds %>
<% active_clock = user_exploration.active_segment_clock %>
<% remaining_seconds = (active_clock ? active_clock[:remaining_seconds] : 0).to_i %>
<% segment_duration = (active_clock ? active_clock[:duration_seconds] : active_segment&.[](:duration_seconds)).to_i %>
<% segment_elapsed = active_clock ? active_clock[:elapsed_seconds].to_i : (segment_duration - remaining_seconds) %>
<% segment_start_at = active_clock ? active_clock[:start_time] : (user_exploration.segment_started_at || user_exploration.started_at) %>
<% elapsed_before_segment = [elapsed_seconds - segment_elapsed, 0].max %>
<% checkpoint_url = checkpoint_user_exploration_path(user_exploration) %>
<% segment_end_at = if active_clock && active_clock[:end_time].present?
                      active_clock[:end_time]
                    elsif segment_start_at.present? && segment_duration.to_i.positive?
                      segment_start_at + segment_duration.seconds
                    end %>
<% timeline_nodes = [] %>
<% timeline_nodes << { label: "Start", status: 'completed' } %>
<% segment_entries.each do |segment| %>
  <% node_label = segment[:label].presence || "Checkpoint #{segment[:index].to_i + 1}" %>
  <% node_status =
       case segment[:status].to_s
       when 'completed' then 'completed'
       when 'checkpoint' then 'checkpoint'
       when 'active' then 'active'
       else 'upcoming'
       end %>
  <% timeline_nodes << { label: node_label, status: node_status } %>
<% end %>
<% edge_count = [timeline_nodes.size - 1, 1].max %>
<% completed_segments = segment_entries.count { |segment| %w[completed checkpoint].include?(segment[:status].to_s) } %>
<% completed_edges = [completed_segments, edge_count].min %>
<% completed_edges = edge_count if user_exploration.complete? %>
<% active_edge_fraction = 0.0 %>
<% stage_total = [segment_entries.size, 1].max %>
<% if active_segment.present? && segment_duration.positive? && completed_edges < edge_count %>
  <% active_edge_fraction = (segment_elapsed.to_f / segment_duration.to_f).clamp(0.0, 1.0) %>
<% end %>

<div class="space-y-4">
  <div class="flex items-center justify-between">
    <p class="text-sm font-semibold text-indigo-600 flex items-center gap-2">
      <span class="inline-flex h-2 w-2 rounded-full bg-indigo-500 animate-pulse"></span>
      Expedition in progress
    </p>
    <p class="text-xs text-slate-500">Started: <%= l(user_exploration.started_at, format: :short) %></p>
  </div>

  <% party_members = user_exploration.user_pets.order(:active_slot, :id) %>
  <% if party_members.any? %>
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Party</span>
      <% party_members.each do |member| %>
        <% label = member.name.presence || member.pet.name %>
        <div class="h-12 w-12 rounded-xl border border-slate-200 bg-white/80 shadow-sm overflow-hidden">
          <%= image_tag pet_sprite_path(member.pet),
                        alt: label,
                        class: "h-full w-full object-contain" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if active_segment.present? %>
    <div data-controller="countdown"
         data-countdown-seconds-value="<%= remaining_seconds %>"
         data-countdown-total-value="<%= total_duration %>"
         data-countdown-elapsed-value="<%= elapsed_before_segment %>"
         data-countdown-checkpoint-url-value="<%= checkpoint_url %>"
         data-countdown-segment-index-value="<%= active_segment[:index].to_i %>"
         data-countdown-segment-total-value="<%= segment_duration %>"
         data-countdown-segment-elapsed-value="<%= segment_elapsed %>"
         <%= %(data-countdown-end-at-value="#{segment_end_at.iso8601}") if segment_end_at.present? %>
         data-countdown-active-encounter-value="<%= user_exploration.active_encounter? %>"
         data-countdown-total-edges-value="<%= edge_count %>"
         data-countdown-completed-edges-value="<%= completed_edges %>"
         data-countdown-active-edge-fraction-value="<%= active_edge_fraction %>"
         data-user-exploration-id="<%= user_exploration.id %>">
      <%= render "explorations/segment_timeline",
                 nodes: timeline_nodes,
                 edge_count: edge_count,
                 completed_edges: completed_edges,
                 active_edge_fraction: active_edge_fraction %>
      <div class="rounded-xl border border-indigo-100 bg-white px-4 py-3 shadow-sm mt-3">
        <div class="flex items-center justify-between text-[11px] font-semibold uppercase text-slate-500">
          <span>Current Segment</span>
          <span>Stage <%= active_segment[:index].to_i + 1 %> / <%= stage_total %></span>
        </div>
        <div class="mt-2 flex items-end justify-between">
          <div>
            <p class="text-sm font-semibold text-slate-900">
              <%= active_segment[:label] || "Checkpoint #{active_segment[:index].to_i + 1}" %>
            </p>
            <p class="text-xs text-slate-500">Time remaining</p>
          </div>
          <span class="text-lg font-bold text-indigo-600"
                data-countdown-target="output">
            <%= exploration_duration_label(remaining_seconds) %>
          </span>
        </div>
      </div>
    </div>
  <% else %>
    <%= render "explorations/segment_timeline",
               nodes: timeline_nodes,
               edge_count: edge_count,
               completed_edges: completed_edges,
               active_edge_fraction: active_edge_fraction %>
    <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
      Awaiting the next stage to begin…
    </div>
  <% end %>

  <% if ready_encounter.present? %>
    <% encounter = ready_encounter.with_indifferent_access %>
    <% title = encounter.dig(:encounter, :title) || encounter[:title] || "Encounter available" %>
    <div class="rounded-xl border border-indigo-200 bg-indigo-50 px-4 py-3">
      <p class="text-[11px] font-semibold uppercase text-indigo-500">Encounter queued</p>
      <p class="text-sm font-semibold text-indigo-700"><%= title %></p>
      <p class="text-xs text-indigo-500">Checkpoint reached—prepare for the challenge ahead.</p>
    </div>
  <% elsif upcoming_encounter.present? %>
    <% encounter = upcoming_encounter.with_indifferent_access %>
    <% label = encounter[:segment_label] || "Checkpoint #{encounter[:segment_index].to_i + 1}" %>
    <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
      <p class="text-[11px] font-semibold uppercase text-slate-500">Next encounter check</p>
      <p class="text-sm font-semibold text-slate-700"><%= label %></p>
    </div>
  <% end %>

  <%= render "explorations/zone_card/requirements", requirement_progress: requirement_progress %>
</div>
