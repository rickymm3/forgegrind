<%# locals: offer (optional), currency_balances %>
<% is_hero = local_assigns.key?(:hero) ? !!hero : true %>
<% wrapper_classes = ["store-panel", "space-y-4"] %>
<% wrapper_classes << "store-panel--hero" if is_hero %>

<% if offer.present? %>
  <% item        = offer[:item] %>
  <% metadata    = inventory_item_metadata(item) %>
  <% rarity      = metadata[:rarity] || "common" %>
  <% rarity_label = rarity.to_s.titleize %>
  <% frame_class = rarity_frame_class(rarity) %>
  <% rarity_color = rarity_color_class(rarity) %>
  <% description = item_description(item).presence || "Curated caretaker supply." %>
  <% currency    = offer[:currency] %>
  <% price_label = currency ? "#{offer[:price]} #{currency.name}" : "#{offer[:price]}" %>
  <% icon_path   = care_item_image_path(item.item_type) %>
  <% balance     = currency ? current_user.currency_balance(currency) : Float::INFINITY %>
  <% can_afford  = price_label.present? ? (balance >= offer[:price].to_i) : true %>
  <% afford_hint = currency && !can_afford ? "You need #{offer[:price] - balance} more #{currency.name.downcase}." : nil %>

  <div data-controller="action-panel">
    <button type="button"
            class="fixed inset-0 z-40 bg-slate-950/70 backdrop-blur-sm transition-opacity duration-200 ease-out opacity-100"
            data-action="action-panel#submitCancel"
            data-turbo-frame="store-item-hero"
            aria-label="Close store sheet"></button>

    <div class="fixed left-0 right-0 z-50 px-4 transition-all duration-200 ease-out opacity-100 translate-y-0" style="bottom: calc(env(safe-area-inset-bottom, 0px) + 6.5rem);">
      <div class="pointer-events-auto mx-auto max-w-3xl rounded-3xl border border-slate-800 bg-slate-950/95 p-5 pb-8 shadow-2xl shadow-slate-950/50 space-y-6">
        <header class="flex items-start justify-between gap-4">
          <div class="flex items-start gap-4">
            <div class="relative">
              <div class="relative aspect-square h-24 w-24 overflow-hidden rounded-3xl border-2 <%= frame_class %> bg-slate-900/80">
                <% if icon_path.present? %>
                  <%= image_tag icon_path, alt: "", class: "absolute inset-0 h-full w-full object-contain p-4" %>
                <% else %>
                  <div class="absolute inset-0 flex items-center justify-center text-sm text-slate-300">No Art</div>
                <% end %>
              </div>
              <span class="absolute -bottom-2 -right-2 inline-flex items-center rounded-full bg-indigo-600 px-3 py-1 text-xs font-semibold text-white shadow-lg shadow-indigo-900/40">
                <%= price_label %>
              </span>
            </div>
            <% owned_count = current_user.user_items.where(item_id: item.id).sum(:quantity) %>
            <div class="space-y-1">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold text-slate-100"><%= item.name %></h2>
                <span class="inline-flex items-center rounded-full border border-slate-700/70 bg-slate-900/70 px-2.5 py-1 text-[11px] font-semibold text-slate-200">
                  x<%= owned_count %> owned
                </span>
              </div>
              <p class="text-xs uppercase tracking-wide text-<%= rarity_color %>"><%= rarity_label %></p>
              <p class="text-xs text-slate-400 leading-relaxed max-w-sm"><%= description %></p>
            </div>
          </div>
          <%= button_to store_path(tab: "items"),
                        method: :get,
                        data: { turbo_frame: "store-item-hero", "action-panel-target": "cancelForm" },
                        class: "inline-flex items-center gap-2 rounded-full border border-slate-700/70 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950" do %>
            Exit
          <% end %>
        </header>

        <div class="store-item-panel grid gap-3 sm:grid-cols-3 pb-10">
          <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
            <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Price</p>
            <p class="mt-1 text-sm font-semibold text-emerald-200"><%= price_label %></p>
            <% if afford_hint %>
              <p class="mt-1 text-[11px] text-amber-300"><%= afford_hint %></p>
            <% else %>
              <p class="mt-1 text-[11px] text-slate-400">You have <%= balance %> <%= currency.name.downcase %>.</p>
            <% end %>
          </div>
          <!--
          <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
            <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Category</p>
            <p class="mt-1 text-sm font-semibold text-slate-200"><%= item.item_type.to_s.humanize %></p>
            <p class="mt-1 text-[11px] text-slate-400">Appears in the caretaker store and special events.</p>
          </div>
          <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 px-4 py-3 text-xs text-slate-300">
            <p class="font-semibold text-slate-100 uppercase tracking-wide text-[11px]">Usage</p>
            <p class="mt-1 text-[11px] text-slate-400">Purchase to add to your inventory for pet care actions.</p>
          </div>
        </div> 
        -->

        <div class="flex items-center justify-between gap-3">
          <%= button_to "Buy for #{price_label}",
                        store_purchase_item_path(offer[:item_type]),
                        method: :post,
                        data: { turbo_stream: true },
                        disabled: !can_afford,
                        class: "inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition #{can_afford ? 'bg-amber-500 text-slate-900 hover:bg-amber-400' : 'bg-slate-800 text-slate-500 cursor-not-allowed opacity-70'}",
                        form: { data: { turbo_frame: "store-item-hero" } } %>
          <% if afford_hint %>
            <p class="text-xs text-amber-200"><%= afford_hint %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <div class="<%= (wrapper_classes - ["space-y-4"]).push("space-y-3").join(" ") %>">
    <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Caretaker's Counter</p>
    <h2 class="text-2xl font-semibold text-white">Stock up for the journey</h2>
    <p class="text-sm text-slate-300 max-w-2xl">Trusted supplies for feeding, grooming, and bonding with your companions. Tap an item below to view details and purchase.</p>
  </div>
<% end %>
